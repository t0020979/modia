# 🏗️ Архитектура Modia

**Версия:** 1.2.0  
**Последнее обновление:** 2026-02-17

> Лёгкий компонентный фреймворк на чистом JavaScript для управления динамическим UI в legacy-проектах. Без внешних зависимостей. Совместим с Rails, jQuery, Webpacker.

## 📖 Оглавление
- [Архитектурные слои](#-архитектурные-слои)
- [Ключевые принципы](#-ключевые-принципы)
- [Поток данных](#-поток-данных)
- [Жизненный цикл компонента](#-жизненный-цикл-компонента)
- [Обработка ошибок](#-обработка-ошибок)
- [Стратегия тестирования](#-стратегия-тестирования)
- [Документация](#-документация)

---


## 📦 Архитектурные слои

```
modia/
├── core.js              ← Ядро: BaseComponent, Container, ComponentScanner
├── index.js             ← Точка входа: регистрация + экспорт Modia.scan()
├── components/          ← Компоненты (поведение контейнера)
│   ├── validation.js    ← ValidationComponent (v1.2)
│   └── debug.js         ← DebugComponent (v1.2)
│   └── debug-panel.js   ← DebugPanel Component (v1.3+) ⏳
├── services/            ← Сервисы (логика без состояния)
│   ├── logger.js        ← Logger Service (v1.2)
│   ├── field-validator.js ← FieldValidator (v1.2)
│   └── field-error-renderer.js ← FieldErrorRenderer (v1.2)
├── configurations/      ← Конфигурации (чистые данные)
│   └── validation-rules.js ← validationRules (v1.2)
└── styles/              ← Стили (v1.3+) ⏳
    └── modia.css        ← Основные стили фреймворка
```

## 🧱 Ключевые принципы

| Принцип | Описание |
|---------|----------|
| Автоинициализация | Компоненты создаются автоматически при наличии `data-component` |
| Декларативная конфигурация | Настройка через `data-*` атрибуты без JavaScript |
| Изоляция | Каждый компонент работает только внутри своего корня (`this.$el`) |
| Расширяемость без изменения ядра | Новые правила → массив, новые режимы → мета-атрибуты |
| Поддержка динамики | `Modia.scan(container)` для AJAX/Turbolinks |
| Поведение контейнера | Компонент на форме/секции, не на отдельных полях |

## 🔄 Поток данных

```
┌─────────┐     ┌──────────────────┐     ┌─────────────┐     ┌──────────────┐
│   DOM   │ ──→ │ ComponentScanner │ ──→ │  Component  │ ──→ │  Container   │
│ (HTML)  │     │   (scan root)    │     │ (create)    │     │ (state mgr)  │
└─────────┘     └──────────────────┘     └─────────────┘     └──────────────┘
                                                              │
                                                              ↓
                                                      onStateChange()
                                                              │
                                                              ↓
                                                     ┌─────────────┐
                                                     │   Service   │
                                                     │ (Validator) │
                                                     └─────────────┘
                                                              │
                                                              ↓
                                                     ┌─────────────┐
                                                     │  Renderer   │
                                                     │  (Error)    │
                                                     └─────────────┘
```

## 🔁 Жизненный цикл компонента

| Стадия | Метод | Описание |
|--------|-------|----------|
| Сканирование | ComponentScanner.scan() | Находит `[data-component="name"]` в DOM |
| Создание | new Component(element) | Парсинг конфигурации из `data-*` |
| Регистрация | container.addComponent() | Добавляет компонент в контейнер (опционально) |
| Работа | onStateChange(state) | Слушает события, обновляет UI |
| Уничтожение | destroy() | Очищает обработчики при замене DOM |

## ⚠️ Обработка ошибок

### Иерархия источников ошибок (5 уровней)

| Приоритет | Источник | Пример |
|-----------|----------|--------|
| 1 | Inline-атрибут | `data-error-text-required="Заполните"` |
| 2 | Шаблон в контейнере | `.error-templates [data-rule="required"]` |
| 3 | Отдельные шаблоны | `#error_span`, `#format-error-span` |
| 4 | Сообщение из правила | `rule.defaultMessage` |
| 5 | Fallback | `"Field error"` (только для отладки) |

## 🧪 Стратегия тестирования

| Уровень | Расположение | Инструмент |
|---------|-------------|------------|
| Unit-тесты | tests/unit/ | Jest |
| Integration-тесты | tests/integration/ | Jest + jsdom |
| E2E-примеры | examples/ | Браузер |

## 📚 Документация

| Аудитория | Файлы |
|-----------|-------|
| Пользователи | README.md, docs/api/ |
| Разработчики фреймворка | CONTRIBUTING.md, docs/components/ |
| Архитектор | Этот файл |
