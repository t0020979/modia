<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç validation-rules.js: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–∫–æ–º</title>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../examples.css">
  <link rel="stylesheet" href="../../../modia/modia.css">
  <style>
    .console-log {
      background: #1e1e1e;
      color: #0f0;
      padding: 15px;
      max-height: 300px;
      overflow: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .pass {
      color: #28a745;
      font-weight: bold
    }

    .fail {
      color: #dc3545;
      font-weight: bold
    }

    .info {
      color: #17a2b8
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h3>üß™ –¢–µ—Å—Ç validation-rules.js: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–∫–æ–º FieldValidator</h3>
    <div class="expected-result mb-3">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul class="mb-0">
        <li>–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –º–æ–∫–æ–≤—ã–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–º (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ FieldValidator)</li>
        <li>–ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ</li>
        <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ValidationRule</li>
      </ul>
    </div>
    <div class="mb-3">
      <button class="btn btn-success" id="btn-run">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      <button class="btn btn-secondary" id="btn-clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    <div class="console-log" id="console-log"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small></div>
    <div class="mt-2" id="status"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <script type="module">
    import { validationRules, isEmpty, normalizeValue, formatMessage } from '../../../modia/configurations/validation-rules.js';

    function log(msg, type = 'info') {
      const $l = $('#console-log'), ts = new Date().toLocaleTimeString('ru-RU');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      $l.append(`<div class="${cls}"><small>[${ts}] ${msg}</small></div>`);
      $l.scrollTop($l[0].scrollHeight); console.log(`[Test] ${msg}`);
    }
    function assert(cond, msg) { if (cond) { log(`‚úÖ ${msg}`, 'pass'); return true; } else { log(`‚ùå ${msg}`, 'fail'); return false; } }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function updateStatus(t) { $('#status').html(`<strong>–°—Ç–∞—Ç—É—Å:</strong> ${t}`); }

    // –ú–æ–∫–æ–≤—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å FieldValidator)
    function createMockValidator(value, $field) {
      return {
        getFieldValue: () => value,
        $valueSource: $field || $('<input>'),
        $errorScreen: $field || $('<input>'),
        $root: $('<form>'),
        errorRenderer: { clearError: () => { }, renderError: () => { } }
      };
    }

    async function runAllTests() {
      updateStatus('üîÑ –ó–∞–ø—É—Å–∫...'); log('=== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ú–û–ö–û–ú ===', 'info');
      let passed = 0, total = 0;

      // 1. –ü—Ä–∞–≤–∏–ª–æ required —Å –º–æ–∫–æ–º
      const reqRule = validationRules.find(r => r.name === 'required');
      if (reqRule) {
        let r = reqRule.validate($('<input>'), createMockValidator('test'));
        assert(r === true, 'required + mock: "test" ‚Üí OK'); passed++; total++;

        r = reqRule.validate($('<input>'), createMockValidator(''));
        assert(r && r.valid === false, 'required + mock: "" ‚Üí –æ—à–∏–±–∫–∞'); passed++; total++;
      }

      // 2. –ü—Ä–∞–≤–∏–ª–æ max-length —Å –º–æ–∫–æ–º
      const maxRule = validationRules.find(r => r.name === 'max-length');
      if (maxRule) {
        const $f = $('<input data-max-length="5">');
        let r = maxRule.validate($f, createMockValidator('abc', $f));
        assert(r === true, 'max-length + mock: 3 ‚â§ 5 ‚Üí OK'); passed++; total++;

        r = maxRule.validate($f, createMockValidator('toolong', $f));
        assert(r && r.valid === false, 'max-length + mock: 7 > 5 ‚Üí –æ—à–∏–±–∫–∞'); passed++; total++;
      }

      // 3. –ü—Ä–∞–≤–∏–ª–æ format —Å –º–æ–∫–æ–º
      const fmtRule = validationRules.find(r => r.name === 'format');
      if (fmtRule) {
        const $f = $('<input data-format="^\\d{3}$">');
        let r = fmtRule.validate($f, createMockValidator('123', $f));
        assert(r === true, 'format + mock: "123" ‚Üí OK'); passed++; total++;

        r = fmtRule.validate($f, createMockValidator('abc', $f));
        assert(r && r.valid === false, 'format + mock: "abc" ‚Üí –æ—à–∏–±–∫–∞'); passed++; total++;
      }

      // 4. –ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ValidationRule)
      const customRule = {
        name: 'custom-test',
        selector: '[data-custom]',
        templateId: 'custom-error-span',
        defaultMessage: 'Custom error',
        messageLevel: 4,
        validate($field, validator) {
          const val = validator.getFieldValue();
          return val === 'ok' ? true : { valid: false, params: { value: val } };
        }
      };
      let r = customRule.validate($('<input>'), createMockValidator('ok'));
      assert(r === true, 'custom rule + mock: "ok" ‚Üí OK'); passed++; total++;

      r = customRule.validate($('<input>'), createMockValidator('fail'));
      assert(r && r.valid === false, 'custom rule + mock: "fail" ‚Üí –æ—à–∏–±–∫–∞'); passed++; total++;

      // 5. –ú–∞—Å—Å–∏–≤ –ø—Ä–∞–≤–∏–ª + –º–æ–∫
      const mockRules = [reqRule, maxRule].filter(Boolean);
      let allValid = true;
      for (const rule of mockRules) {
        const result = rule.validate($('<input>'), createMockValidator('test'));
        if (result && result.valid === false) allValid = false;
      }
      assert(allValid === true, '–º–∞—Å—Å–∏–≤ –ø—Ä–∞–≤–∏–ª + mock: –≤—Å–µ –≤–∞–ª–∏–¥–Ω–æ'); passed++; total++;

      // 6. isEmpty –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞
      assert(isEmpty(normalizeValue('')[0]) === true, 'isEmpty + normalizeValue: "" ‚Üí true'); passed++; total++;

      // 7. formatMessage –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞
      const msg = formatMessage('–î–ª–∏–Ω–∞: __COUNT__', { count: 10 });
      assert(msg === '–î–ª–∏–Ω–∞: 10', 'formatMessage + –ø—Ä–∞–≤–∏–ª–æ: –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞'); passed++; total++;

      log(`=== –ò–¢–û–ì–û: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`, passed === total ? 'pass' : 'fail');
      updateStatus(passed === total ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');
      return passed === total;
    }

    $('#btn-run').on('click', runAllTests);
    $('#btn-clear').on('click', () => {
      $('#console-log').html('<small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small>');
      updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...'); log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });
    $(document).ready(() => { log('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∞–º', 'pass'); updateStatus('–ì–æ—Ç–æ–≤'); });
  </script>
</body>

</html>