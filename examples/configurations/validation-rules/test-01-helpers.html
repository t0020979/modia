<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç validation-rules.js: Helpers</title>

  <!-- ‚úÖ jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- ‚úÖ Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã CSS (2 —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö) -->
  <link rel="stylesheet" href="../../examples.css">

  <!-- ‚úÖ Modia CSS -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <style>
    .console-log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .pass {
      color: #28a745;
      font-weight: bold;
    }

    .fail {
      color: #dc3545;
      font-weight: bold;
    }

    .info {
      color: #17a2b8;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h3>üß™ –¢–µ—Å—Ç validation-rules.js: Helper Functions</h3>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result mb-3">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul class="mb-0">
        <li><code>isEmpty()</code> –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</li>
        <li><code>formatMessage()</code> –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (case-insensitive)</li>
        <li><code>normalizeValue()</code> –ø—Ä–∏–≤–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –º–∞—Å—Å–∏–≤—É</li>
        <li>–í—Å–µ —Ö–µ–ª–ø–µ—Ä—ã ‚Äî —á–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤)</li>
      </ul>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="mb-3">
      <button class="btn btn-success" id="btn-run">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      <button class="btn btn-secondary" id="btn-clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      <button class="btn btn-info" id="btn-auto">‚ñ∂Ô∏è –ê–≤—Ç–æ-—Ç–µ—Å—Ç</button>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="console-log" id="console-log"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small></div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="mt-2" id="status"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <script type="module">
    // –ò–º–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ —Ö–µ–ª–ø–µ—Ä–æ–≤ (–Ω–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞)
    import { isEmpty, formatMessage, normalizeValue } from '../../../modia/configurations/validation-rules.js';

    // ========================================================================
    // –£–¢–ò–õ–ò–¢–´ –¢–ï–°–¢–ê
    // ========================================================================

    function log(msg, type = 'info') {
      const $log = $('#console-log');
      const ts = new Date().toLocaleTimeString('ru-RU');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      $log.append(`<div class="${cls}"><small>[${ts}] ${msg}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[Test] ${msg}`);
    }

    function assert(cond, msg) {
      if (cond) {
        log(`‚úÖ ${msg}`, 'pass');
        return true;
      } else {
        log(`‚ùå ${msg}`, 'fail');
        return false;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateStatus(text) {
      $('#status').html(`<strong>–°—Ç–∞—Ç—É—Å:</strong> ${text}`);
    }

    // ========================================================================
    // –¢–ï–°–¢–´: isEmpty()
    // ========================================================================

    function testIsEmpty() {
      log('--- –¢–µ—Å—Ç—ã: isEmpty() ---', 'info');
      let passed = 0;

      // –°—Ç—Ä–æ–∫–∏
      assert(isEmpty('') === true, 'isEmpty("") = true'); passed++;
      assert(isEmpty('  ') === true, 'isEmpty("  ") = true'); passed++;
      assert(isEmpty('test') === false, 'isEmpty("test") = false'); passed++;

      // Null/undefined
      assert(isEmpty(null) === true, 'isEmpty(null) = true'); passed++;
      assert(isEmpty(undefined) === true, 'isEmpty(undefined) = true'); passed++;

      // –ú–∞—Å—Å–∏–≤—ã
      assert(isEmpty([]) === true, 'isEmpty([]) = true'); passed++;
      assert(isEmpty(['']) === true, 'isEmpty([""]) = true'); passed++;
      assert(isEmpty(['', null]) === true, 'isEmpty(["", null]) = true'); passed++;
      assert(isEmpty(['test']) === false, 'isEmpty(["test"]) = false'); passed++;
      assert(isEmpty(['', 'x']) === false, 'isEmpty(["", "x"]) = false'); passed++;

      // –ß–∏—Å–ª–∞ –∏ –æ–±—ä–µ–∫—Ç—ã
      assert(isEmpty(0) === false, 'isEmpty(0) = false (—á–∏—Å–ª–æ –Ω–µ –ø—É—Å—Ç–æ)'); passed++;
      assert(isEmpty({}) === false, 'isEmpty({}) = false (–æ–±—ä–µ–∫—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º)'); passed++;

      log(`isEmpty(): ${passed}/12 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === 12 ? 'pass' : 'fail');
      return passed === 12;
    }

    // ========================================================================
    // –¢–ï–°–¢–´: formatMessage()
    // ========================================================================

    function testFormatMessage() {
      log('--- –¢–µ—Å—Ç—ã: formatMessage() ---', 'info');
      let passed = 0;

      // –ë–∞–∑–æ–≤–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
      assert(
        formatMessage('Hi __NAME__', { name: 'Alex' }) === 'Hi Alex',
        '–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ __NAME__ (lowercase key)'
      ); passed++;

      // Case-insensitive –∫–ª—é—á–∏
      assert(
        formatMessage('Count: __COUNT__', { count: 5 }) === 'Count: 5',
        '__COUNT__ ‚Üí {count: 5}'
      ); passed++;
      assert(
        formatMessage('Count: __count__', { COUNT: 10 }) === 'Count: 10',
        '__count__ ‚Üí {COUNT: 10}'
      ); passed++;

      // –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      assert(
        formatMessage('__A__ + __B__ = __C__', { a: 2, b: 3, c: 5 }) === '2 + 3 = 5',
        '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞'
      ); passed++;

      // –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
      assert(
        formatMessage('Value: __MISSING__', {}) === 'Value: __MISSING__',
        '–ù–µ–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –æ—Å—Ç–∞—ë—Ç—Å—è'
      ); passed++;

      // –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      assert(formatMessage('Static text', {}) === 'Static text', '–°—Ç–∞—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç'); passed++;

      // –ü—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω
      assert(formatMessage('', { x: 1 }) === '', '–ü—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω'); passed++;

      log(`formatMessage(): ${passed}/7 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === 7 ? 'pass' : 'fail');
      return passed === 7;
    }

    // ========================================================================
    // –¢–ï–°–¢–´: normalizeValue()
    // ========================================================================

    function testNormalizeValue() {
      log('--- –¢–µ—Å—Ç—ã: normalizeValue() ---', 'info');
      let passed = 0;

      // –°—Ç—Ä–æ–∫–∞ ‚Üí –º–∞—Å—Å–∏–≤
      const r1 = normalizeValue('test');
      assert(Array.isArray(r1) && r1[0] === 'test', 'normalizeValue("test") ‚Üí ["test"]'); passed++;

      // –ú–∞—Å—Å–∏–≤ ‚Üí –º–∞—Å—Å–∏–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const r2 = normalizeValue(['a', 'b']);
      assert(Array.isArray(r2) && r2.length === 2, 'normalizeValue(["a","b"]) ‚Üí ["a","b"]'); passed++;

      // Null/undefined ‚Üí –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
      const r3 = normalizeValue(null);
      assert(Array.isArray(r3) && r3[0] === null, 'normalizeValue(null) ‚Üí [null]'); passed++;

      // –ß–∏—Å–ª–æ ‚Üí –º–∞—Å—Å–∏–≤
      const r4 = normalizeValue(42);
      assert(Array.isArray(r4) && r4[0] === 42, 'normalizeValue(42) ‚Üí [42]'); passed++;

      log(`normalizeValue(): ${passed}/4 —Ç–µ—Å—Ç–∞ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === 4 ? 'pass' : 'fail');
      return passed === 4;
    }

    // ========================================================================
    // –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í
    // ========================================================================

    async function runAllTests() {
      updateStatus('üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...');
      log('=== –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í HELPERS ===', 'info');

      const results = [
        testIsEmpty(),
        await sleep(100).then(() => testFormatMessage()),
        await sleep(100).then(() => testNormalizeValue())
      ];

      const total = results.filter(r => r).length;
      log(`=== –ò–¢–û–ì–û: ${total}/3 –≥—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`, total === 3 ? 'pass' : 'fail');
      updateStatus(total === 3 ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');

      return total === 3;
    }

    // ========================================================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ========================================================================

    $('#btn-run').on('click', runAllTests);

    $('#btn-clear').on('click', () => {
      $('#console-log').html('<small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small>');
      updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...');
      log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    $('#btn-auto').on('click', async () => {
      $('#btn-auto').prop('disabled', true);
      await runAllTests();
      await sleep(500);
      $('#btn-auto').prop('disabled', false);
    });

    // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    $(document).ready(() => {
      log('‚úÖ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω', 'pass');
      log('‚úÖ –•–µ–ª–ø–µ—Ä—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'pass');
      updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∞–º');
    });
  </script>
</body>

</html>