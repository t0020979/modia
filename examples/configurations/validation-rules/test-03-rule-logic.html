<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç validation-rules.js: –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª</title>

  <!-- ‚úÖ jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- ‚úÖ Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã CSS (2 —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö) -->
  <link rel="stylesheet" href="../../examples.css">

  <!-- ‚úÖ Modia CSS -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <style>
    .console-log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .pass {
      color: #28a745;
      font-weight: bold;
    }

    .fail {
      color: #dc3545;
      font-weight: bold;
    }

    .info {
      color: #17a2b8;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h3>üß™ –¢–µ—Å—Ç validation-rules.js: –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª</h3>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result mb-3">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul class="mb-0">
        <li><code>required</code>: –ø—É—Å—Ç–æ–µ = –æ—à–∏–±–∫–∞, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ = OK</li>
        <li><code>max-length</code>: –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–ª–∏–Ω—ã = –æ—à–∏–±–∫–∞</li>
        <li><code>min-length</code>: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª–∏–Ω–∞ = –æ—à–∏–±–∫–∞</li>
        <li><code>format</code>: –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ regex = –æ—à–∏–±–∫–∞</li>
        <li><code>email</code>: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π email = –æ—à–∏–±–∫–∞</li>
        <li>–ú–∞—Å—Å–∏–≤—ã –ø–æ–ª–µ–π: —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ = OK</li>
      </ul>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="mb-3">
      <button class="btn btn-success" id="btn-run">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      <button class="btn btn-secondary" id="btn-clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      <button class="btn btn-info" id="btn-auto">‚ñ∂Ô∏è –ê–≤—Ç–æ-—Ç–µ—Å—Ç</button>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="console-log" id="console-log"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small></div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="mt-2" id="status"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <script type="module">
    import { validationRules, isEmpty, normalizeValue } from '../../../modia/configurations/validation-rules.js';

    // ========================================================================
    // –£–¢–ò–õ–ò–¢–´ –¢–ï–°–¢–ê
    // ========================================================================

    function log(msg, type = 'info') {
      const $log = $('#console-log');
      const ts = new Date().toLocaleTimeString('ru-RU');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      $log.append(`<div class="${cls}"><small>[${ts}] ${msg}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[Test] ${msg}`);
    }

    function assert(cond, msg) {
      if (cond) {
        log(`‚úÖ ${msg}`, 'pass');
        return true;
      } else {
        log(`‚ùå ${msg}`, 'fail');
        return false;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateStatus(text) {
      $('#status').html(`<strong>–°—Ç–∞—Ç—É—Å:</strong> ${text}`);
    }

    // –ú–æ–∫–æ–≤—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª
    function createMockValidator(value) {
      return {
        getFieldValue: () => value,
        $valueSource: $('<input>'),
        $errorScreen: $('<input>'),
        $root: $('<form>'),
        errorRenderer: { clearError: () => { }, renderError: () => { } }
      };
    }

    // ========================================================================
    // –¢–ï–°–¢ 1: –ü—Ä–∞–≤–∏–ª–æ required
    // ========================================================================

    function testRequired() {
      log('--- –¢–µ—Å—Ç 1: –ü—Ä–∞–≤–∏–ª–æ required ---', 'info');
      let passed = 0;
      const total = 6;

      const rule = validationRules.find(r => r.name === 'required');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ required –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
      let result = rule.validate($('<input>'), createMockValidator(''));
      assert(result && result.valid === false, 'required: "" ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ü—Ä–æ–±–µ–ª—ã
      result = rule.validate($('<input>'), createMockValidator('   '));
      assert(result && result.valid === false, 'required: "   " ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
      result = rule.validate($('<input>'), createMockValidator('test'));
      assert(result === true, 'required: "test" ‚Üí OK'); passed++;

      // Null
      result = rule.validate($('<input>'), createMockValidator(null));
      assert(result && result.valid === false, 'required: null ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ú–∞—Å—Å–∏–≤: –≤—Å–µ –ø—É—Å—Ç—ã–µ
      result = rule.validate($('<input>'), createMockValidator(['', '', null]));
      assert(result && result.valid === false, 'required: ["", "", null] ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ú–∞—Å—Å–∏–≤: —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
      result = rule.validate($('<input>'), createMockValidator(['', 'x', '']));
      assert(result === true, 'required: ["", "x", ""] ‚Üí OK'); passed++;

      log(`required: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 2: –ü—Ä–∞–≤–∏–ª–æ max-length
    // ========================================================================

    function testMaxLength() {
      log('--- –¢–µ—Å—Ç 2: –ü—Ä–∞–≤–∏–ª–æ max-length ---', 'info');
      let passed = 0;
      const total = 4;

      const rule = validationRules.find(r => r.name === 'max-length');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ max-length –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
      let $field = $('<input data-max-length="10">');
      let result = rule.validate($field, createMockValidator('test'));
      assert(result === true, 'max-length: 4 ‚â§ 10 ‚Üí OK'); passed++;

      // –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ
      $field = $('<input data-max-length="5">');
      result = rule.validate($field, createMockValidator('too long'));
      assert(result && result.valid === false, 'max-length: 8 > 5 ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ result
      $field = $('<input data-max-length="5">');
      result = rule.validate($field, createMockValidator('toolong'));
      assert(result && result.params && result.params.count === 5, 'max-length: params.count = 5'); passed++;

      // –ë–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∞
      $field = $('<input>');
      result = rule.validate($field, createMockValidator('any'));
      assert(result === true, 'max-length: –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      log(`max-length: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 3: –ü—Ä–∞–≤–∏–ª–æ min-length
    // ========================================================================

    function testMinLength() {
      log('--- –¢–µ—Å—Ç 3: –ü—Ä–∞–≤–∏–ª–æ min-length ---', 'info');
      let passed = 0;
      const total = 4;

      const rule = validationRules.find(r => r.name === 'min-length');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ min-length –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
      let $field = $('<input data-min-length="3">');
      let result = rule.validate($field, createMockValidator('test'));
      assert(result === true, 'min-length: 4 ‚â• 3 ‚Üí OK'); passed++;

      // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª–∏–Ω–∞
      $field = $('<input data-min-length="5">');
      result = rule.validate($field, createMockValidator('abc'));
      assert(result && result.valid === false, 'min-length: 3 < 5 ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ result
      $field = $('<input data-min-length="5">');
      result = rule.validate($field, createMockValidator('ab'));
      assert(result && result.params && result.params.count === 5, 'min-length: params.count = 5'); passed++;

      // –ë–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∞
      $field = $('<input>');
      result = rule.validate($field, createMockValidator('any'));
      assert(result === true, 'min-length: –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      log(`min-length: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 4: –ü—Ä–∞–≤–∏–ª–æ format (regex)
    // ========================================================================

    function testFormat() {
      log('--- –¢–µ—Å—Ç 4: –ü—Ä–∞–≤–∏–ª–æ format ---', 'info');
      let passed = 0;
      const total = 4;

      const rule = validationRules.find(r => r.name === 'format');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ format –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ
      let $field = $('<input data-format="^\\d{3}$">');
      let result = rule.validate($field, createMockValidator('123'));
      assert(result === true, 'format: "123" ‚Üí OK'); passed++;

      // –ù–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
      $field = $('<input data-format="^\\d{3}$">');
      result = rule.validate($field, createMockValidator('abc'));
      assert(result && result.valid === false, 'format: "abc" ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ù–µ–≤–µ—Ä–Ω—ã–π regex (–¥–æ–ª–∂–µ–Ω –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å)
      $field = $('<input data-format="[invalid">');
      result = rule.validate($field, createMockValidator('any'));
      assert(result === true, 'format: –Ω–µ–≤–µ—Ä–Ω—ã–π regex ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      // –ë–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∞
      $field = $('<input>');
      result = rule.validate($field, createMockValidator('any'));
      assert(result === true, 'format: –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      log(`format: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 5: –ü—Ä–∞–≤–∏–ª–æ email
    // ========================================================================

    function testEmail() {
      log('--- –¢–µ—Å—Ç 5: –ü—Ä–∞–≤–∏–ª–æ email ---', 'info');
      let passed = 0;
      const total = 4;

      const rule = validationRules.find(r => r.name === 'email');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ email –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –í–∞–ª–∏–¥–Ω—ã–π email
      let result = rule.validate($('<input type="email">'), createMockValidator('test@example.com'));
      assert(result === true, 'email: "test@example.com" ‚Üí OK'); passed++;

      // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email
      result = rule.validate($('<input type="email">'), createMockValidator('invalid'));
      assert(result && result.valid === false, 'email: "invalid" ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
      result = rule.validate($('<input type="email">'), createMockValidator(''));
      assert(result === true, 'email: "" ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      // –ú–∞—Å—Å–∏–≤ emails
      result = rule.validate($('<input type="email">'), createMockValidator(['a@b.com', 'c@d.com']));
      assert(result === true, 'email: ["a@b.com", "c@d.com"] ‚Üí OK'); passed++;

      log(`email: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 6: –ü—Ä–∞–≤–∏–ª–æ pattern (HTML5)
    // ========================================================================

    function testPattern() {
      log('--- –¢–µ—Å—Ç 6: –ü—Ä–∞–≤–∏–ª–æ pattern ---', 'info');
      let passed = 0;
      const total = 3;

      const rule = validationRules.find(r => r.name === 'pattern');
      if (!rule) { log('‚ùå –ü—Ä–∞–≤–∏–ª–æ pattern –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'fail'); return false; }

      // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ
      let $field = $('<input pattern="[A-Z]{3}">');
      let result = rule.validate($field, createMockValidator('ABC'));
      assert(result === true, 'pattern: "ABC" ‚Üí OK'); passed++;

      // –ù–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
      $field = $('<input pattern="[A-Z]{3}">');
      result = rule.validate($field, createMockValidator('abc'));
      assert(result && result.valid === false, 'pattern: "abc" ‚Üí –æ—à–∏–±–∫–∞'); passed++;

      // –ë–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–∞
      $field = $('<input>');
      result = rule.validate($field, createMockValidator('any'));
      assert(result === true, 'pattern: –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++;

      log(`pattern: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í
    // ========================================================================

    async function runAllTests() {
      updateStatus('üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...');
      log('=== –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í: –õ–û–ì–ò–ö–ê –ü–†–ê–í–ò–õ ===', 'info');

      const results = [
        testRequired(),
        await sleep(100).then(() => testMaxLength()),
        await sleep(100).then(() => testMinLength()),
        await sleep(100).then(() => testFormat()),
        await sleep(100).then(() => testEmail()),
        await sleep(100).then(() => testPattern())
      ];

      const total = results.filter(r => r).length;
      log(`=== –ò–¢–û–ì–û: ${total}/6 –≥—Ä—É–ø–ø —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`, total === 6 ? 'pass' : 'fail');
      updateStatus(total === 6 ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');

      return total === 6;
    }

    // ========================================================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ========================================================================

    $('#btn-run').on('click', runAllTests);

    $('#btn-clear').on('click', () => {
      $('#console-log').html('<small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small>');
      updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...');
      log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    $('#btn-auto').on('click', async () => {
      $('#btn-auto').prop('disabled', true);
      await runAllTests();
      await sleep(500);
      $('#btn-auto').prop('disabled', false);
    });

    // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    $(document).ready(() => {
      log('‚úÖ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω', 'pass');
      log('‚úÖ validationRules –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'pass');
      updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∞–º');
    });
  </script>
</body>

</html>