<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç validation-rules.js: –ö—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏</title>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../examples.css">
  <link rel="stylesheet" href="../../../modia/modia.css">
  <style>
    .console-log {
      background: #1e1e1e;
      color: #0f0;
      padding: 15px;
      max-height: 300px;
      overflow: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .pass {
      color: #28a745;
      font-weight: bold
    }

    .fail {
      color: #dc3545;
      font-weight: bold
    }

    .info {
      color: #17a2b8
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h3>üß™ –¢–µ—Å—Ç validation-rules.js: –ö—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏</h3>
    <div class="expected-result mb-3">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul class="mb-0">
        <li><code>contenteditable</code> ‚Äî –≤–æ–∑–≤—Ä–∞—Ç —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ HTML</li>
        <li>Checkbox/Radio ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ <code>:checked</code></li>
        <li>–ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –º–∞—Å—Å–∏–≤–∞</li>
        <li>–ü—É—Å—Ç—ã–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏–µ</li>
        <li>–ù–µ–≤–µ—Ä–Ω—ã–π regex ‚Äî –Ω–µ –ª–æ–º–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é</li>
      </ul>
    </div>
    <div class="mb-3">
      <button class="btn btn-success" id="btn-run">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      <button class="btn btn-secondary" id="btn-clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    <div class="console-log" id="console-log"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small></div>
    <div class="mt-2" id="status"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <script type="module">
    import { validationRules, isEmpty, normalizeValue, formatMessage } from '../../../modia/configurations/validation-rules.js';

    function log(msg, type = 'info') {
      const $l = $('#console-log'), ts = new Date().toLocaleTimeString('ru-RU');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      $l.append(`<div class="${cls}"><small>[${ts}] ${msg}</small></div>`);
      $l.scrollTop($l[0].scrollHeight); console.log(`[Test] ${msg}`);
    }
    function assert(cond, msg) { if (cond) { log(`‚úÖ ${msg}`, 'pass'); return true; } else { log(`‚ùå ${msg}`, 'fail'); return false; } }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function updateStatus(t) { $('#status').html(`<strong>–°—Ç–∞—Ç—É—Å:</strong> ${t}`); }
    function mockValidator(val) { return { getFieldValue: () => val }; }

    async function runAllTests() {
      updateStatus('üîÑ –ó–∞–ø—É—Å–∫...'); log('=== –ö–†–ê–ô–ù–ò–ï –°–õ–£–ß–ê–ò ===', 'info');
      let passed = 0, total = 0;

      // 1. Contenteditable ‚Äî —Ç–µ–∫—Å—Ç –±–µ–∑ HTML
      const ceRule = validationRules.find(r => r.name === 'required');
      if (ceRule) {
        const $ce = $('<div contenteditable="true"><b>Text</b></div>');
        const result = ceRule.validate($ce, { getFieldValue: () => 'Text' });
        assert(result === true, 'contenteditable: "Text" ‚Üí OK'); passed++; total++;
      }

      // 2. Checkbox ‚Äî checked
      const reqRule = validationRules.find(r => r.name === 'required');
      if (reqRule) {
        const $chk = $('<input type="checkbox" name="test" value="1">');
        $chk.prop('checked', true);
        const result = reqRule.validate($chk, { getFieldValue: () => '1' });
        assert(result === true, 'checkbox:checked ‚Üí OK'); passed++; total++;

        $chk.prop('checked', false);
        const result2 = reqRule.validate($chk, { getFieldValue: () => '' });
        assert(result2 && result2.valid === false, 'checkbox:unchecked ‚Üí –æ—à–∏–±–∫–∞'); passed++; total++;
      }

      // 3. –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç ‚Äî –º–∞—Å—Å–∏–≤
      const emailRule = validationRules.find(r => r.name === 'email');
      if (emailRule) {
        const result = emailRule.validate($('<select multiple>'), mockValidator(['a@b.com', 'c@d.com']));
        assert(result === true, 'select[multiple]: –º–∞—Å—Å–∏–≤ email ‚Üí OK'); passed++; total++;
      }

      // 4. –ü—É—Å—Ç–æ–π –∞—Ç—Ä–∏–±—É—Ç data-format
      const fmtRule = validationRules.find(r => r.name === 'format');
      if (fmtRule) {
        const $f = $('<input data-format="">');
        const result = fmtRule.validate($f, mockValidator('any'));
        assert(result === true, 'data-format="" ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'); passed++; total++;
      }

      // 5. –ù–µ–≤–µ—Ä–Ω—ã–π regex –≤ format
      if (fmtRule) {
        const $f = $('<input data-format="[invalid">');
        const result = fmtRule.validate($f, mockValidator('test'));
        assert(result === true, '–Ω–µ–≤–µ—Ä–Ω—ã–π regex ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ –æ—à–∏–±–∫–∏'); passed++; total++;
      }

      // 6. formatMessage —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
      assert(formatMessage('Hi __MISSING__', {}) === 'Hi __MISSING__', '–Ω–µ–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –æ—Å—Ç–∞—ë—Ç—Å—è'); passed++; total++;

      // 7. formatMessage —Å null/undefined params
      assert(formatMessage('Hi', null) === 'Hi', 'null params ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —à–∞–±–ª–æ–Ω–∞'); passed++; total++;

      // 8. isEmpty —Å –≥–ª—É–±–æ–∫–∏–º –º–∞—Å—Å–∏–≤–æ–º
      assert(isEmpty([[], [null], ['']]) === true, '–≥–ª—É–±–æ–∫–∏–π –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ ‚Üí true'); passed++; total++;

      // 9. normalizeValue —Å undefined
      const nv = normalizeValue(undefined);
      assert(Array.isArray(nv) && nv[0] === undefined, 'normalizeValue(undefined) ‚Üí [undefined]'); passed++; total++;

      // 10. –ü—Ä–∞–≤–∏–ª–æ ajax ‚Äî –∑–∞–≥–ª—É—à–∫–∞
      const ajaxRule = validationRules.find(r => r.name === 'ajax');
      if (ajaxRule) {
        const result = ajaxRule.validate($('<input data-ajax-validate="/check">'), mockValidator('test'));
        assert(result === true, 'ajax: –∑–∞–≥–ª—É—à–∫–∞ ‚Üí true (v1.2)'); passed++; total++;
      }

      log(`=== –ò–¢–û–ì–û: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`, passed === total ? 'pass' : 'fail');
      updateStatus(passed === total ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');
      return passed === total;
    }

    $('#btn-run').on('click', runAllTests);
    $('#btn-clear').on('click', () => {
      $('#console-log').html('<small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small>');
      updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...'); log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });
    $(document).ready(() => { log('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∞–º', 'pass'); updateStatus('–ì–æ—Ç–æ–≤'); });
  </script>
</body>

</html>