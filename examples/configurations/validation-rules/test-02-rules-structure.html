<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç validation-rules.js: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª</title>

  <!-- ‚úÖ jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- ‚úÖ Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã CSS (2 —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö) -->
  <link rel="stylesheet" href="../../examples.css">

  <!-- ‚úÖ Modia CSS -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <style>
    .console-log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .pass {
      color: #28a745;
      font-weight: bold;
    }

    .fail {
      color: #dc3545;
      font-weight: bold;
    }

    .info {
      color: #17a2b8;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h3>üß™ –¢–µ—Å—Ç validation-rules.js: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª</h3>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result mb-3">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul class="mb-0">
        <li><code>validationRules</code> ‚Äî –º–∞—Å—Å–∏–≤ —Å ‚â•1 –ø—Ä–∞–≤–∏–ª–æ–º</li>
        <li>–ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∏–º–µ–µ—Ç: <code>name</code>, <code>selector</code>, <code>validate</code>,
          <code>templateId</code>, <code>defaultMessage</code>, <code>messageLevel</code></li>
        <li>–í—Å–µ <code>name</code> —É–Ω–∏–∫–∞–ª—å–Ω—ã (kebab-case)</li>
        <li><code>validate</code> ‚Äî —Ñ—É–Ω–∫—Ü–∏—è</li>
        <li><code>messageLevel</code> ‚Äî —á–∏—Å–ª–æ 3-5</li>
      </ul>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="mb-3">
      <button class="btn btn-success" id="btn-run">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      <button class="btn btn-secondary" id="btn-clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      <button class="btn btn-info" id="btn-auto">‚ñ∂Ô∏è –ê–≤—Ç–æ-—Ç–µ—Å—Ç</button>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="console-log" id="console-log"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small></div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="mt-2" id="status"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <script type="module">
    // –ò–º–ø–æ—Ä—Ç –≤—Å–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –ø—Ä–∞–≤–∏–ª
    import { validationRules } from '../../../modia/configurations/validation-rules.js';

    // ========================================================================
    // –£–¢–ò–õ–ò–¢–´ –¢–ï–°–¢–ê
    // ========================================================================

    function log(msg, type = 'info') {
      const $log = $('#console-log');
      const ts = new Date().toLocaleTimeString('ru-RU');
      const cls = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      $log.append(`<div class="${cls}"><small>[${ts}] ${msg}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[Test] ${msg}`);
    }

    function assert(cond, msg) {
      if (cond) {
        log(`‚úÖ ${msg}`, 'pass');
        return true;
      } else {
        log(`‚ùå ${msg}`, 'fail');
        return false;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateStatus(text) {
      $('#status').html(`<strong>–°—Ç–∞—Ç—É—Å:</strong> ${text}`);
    }

    // ========================================================================
    // –¢–ï–°–¢ 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    // ========================================================================

    function testBaseStructure() {
      log('--- –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ---', 'info');
      let passed = 0;
      const total = 4;

      assert(Array.isArray(validationRules), 'validationRules ‚Äî –º–∞—Å—Å–∏–≤'); passed++;
      assert(validationRules.length > 0, '–ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ'); passed++;
      assert(validationRules.length >= 8, '–ï—Å—Ç—å –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (‚â•8)'); passed++;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
      assert(typeof validationRules !== 'undefined', 'validationRules —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω'); passed++;

      log(`–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
    // ========================================================================

    function testRuleStructure() {
      log('--- –¢–µ—Å—Ç 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ ---', 'info');
      let passed = 0;
      let total = 0;

      const requiredFields = ['name', 'selector', 'validate', 'templateId', 'defaultMessage', 'messageLevel'];

      validationRules.forEach((rule, index) => {
        requiredFields.forEach(field => {
          const hasField = rule.hasOwnProperty(field);
          assert(hasField, `–ü—Ä–∞–≤–∏–ª–æ #${index} (${rule.name || 'unnamed'}): –∏–º–µ–µ—Ç "${field}"`);
          if (hasField) passed++;
          total++;
        });
      });

      log(`–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª: ${passed}/${total} –ø–æ–ª–µ–π –Ω–∞–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 3: –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º—ë–Ω (kebab-case)
    // ========================================================================

    function testUniqueNames() {
      log('--- –¢–µ—Å—Ç 3: –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º—ë–Ω (kebab-case) ---', 'info');
      let passed = 0;
      const total = 3;

      const names = validationRules.map(r => r.name);
      const uniqueNames = [...new Set(names)];

      assert(names.length === uniqueNames.length, '–í—Å–µ –∏–º–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª —É–Ω–∏–∫–∞–ª—å–Ω—ã');
      if (names.length === uniqueNames.length) passed++;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ kebab-case
      const kebabCaseRegex = /^[a-z]+(-[a-z]+)*$/;
      const allKebabCase = names.every(name => kebabCaseRegex.test(name));
      assert(allKebabCase, '–í—Å–µ –∏–º–µ–Ω–∞ –≤ kebab-case');
      if (allKebabCase) passed++;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∏–º–µ–Ω–∞
      const noEmptyNames = names.every(name => name && name.length > 0);
      assert(noEmptyNames, '–ù–µ—Ç –ø—É—Å—Ç—ã—Ö –∏–º—ë–Ω');
      if (noEmptyNames) passed++;

      log(`–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º—ë–Ω: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 4: –¢–∏–ø—ã –ø–æ–ª–µ–π
    // ========================================================================

    function testFieldTypes() {
      log('--- –¢–µ—Å—Ç 4: –¢–∏–ø—ã –ø–æ–ª–µ–π ---', 'info');
      let passed = 0;
      let total = 0;

      validationRules.forEach((rule, index) => {
        // name ‚Äî string
        const nameIsString = typeof rule.name === 'string';
        assert(nameIsString, `–ü—Ä–∞–≤–∏–ª–æ #${index}: name ‚Äî string`);
        if (nameIsString) passed++;
        total++;

        // selector ‚Äî string
        const selectorIsString = typeof rule.selector === 'string';
        assert(selectorIsString, `–ü—Ä–∞–≤–∏–ª–æ #${index}: selector ‚Äî string`);
        if (selectorIsString) passed++;
        total++;

        // validate ‚Äî function
        const validateIsFunction = typeof rule.validate === 'function';
        assert(validateIsFunction, `–ü—Ä–∞–≤–∏–ª–æ #${index}: validate ‚Äî function`);
        if (validateIsFunction) passed++;
        total++;

        // templateId ‚Äî string
        const templateIdIsString = typeof rule.templateId === 'string';
        assert(templateIdIsString, `–ü—Ä–∞–≤–∏–ª–æ #${index}: templateId ‚Äî string`);
        if (templateIdIsString) passed++;
        total++;

        // messageLevel ‚Äî number (3-5)
        const messageLevelIsNumber = typeof rule.messageLevel === 'number' &&
          rule.messageLevel >= 3 &&
          rule.messageLevel <= 5;
        assert(messageLevelIsNumber, `–ü—Ä–∞–≤–∏–ª–æ #${index}: messageLevel ‚Äî —á–∏—Å–ª–æ 3-5`);
        if (messageLevelIsNumber) passed++;
        total++;
      });

      log(`–¢–∏–ø—ã –ø–æ–ª–µ–π: ${passed}/${total} –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω–æ`, passed === total ? 'pass' : 'fail');
      return passed === total;
    }

    // ========================================================================
    // –¢–ï–°–¢ 5: –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
    // ========================================================================

    function testRuleList() {
      log('--- –¢–µ—Å—Ç 5: –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª ---', 'info');
      let passed = 0;

      const expectedRules = ['required', 'max-length', 'min-length', 'format', 'pattern', 'email', 'ajax', 'custom'];

      expectedRules.forEach(ruleName => {
        const found = validationRules.some(r => r.name === ruleName);
        assert(found, `–ü—Ä–∞–≤–∏–ª–æ "${ruleName}" –Ω–∞–π–¥–µ–Ω–æ`);
        if (found) passed++;
      });

      log(`–°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª: ${passed}/${expectedRules.length} –Ω–∞–π–¥–µ–Ω–æ`, passed === expectedRules.length ? 'pass' : 'fail');
      return passed === expectedRules.length;
    }

    // ========================================================================
    // –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í
    // ========================================================================

    async function runAllTests() {
      updateStatus('üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...');
      log('=== –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í: –°–¢–†–£–ö–¢–£–†–ê –ü–†–ê–í–ò–õ ===', 'info');

      const results = [
        testBaseStructure(),
        await sleep(100).then(() => testRuleStructure()),
        await sleep(100).then(() => testUniqueNames()),
        await sleep(100).then(() => testFieldTypes()),
        await sleep(100).then(() => testRuleList())
      ];

      const total = results.filter(r => r).length;
      log(`=== –ò–¢–û–ì–û: ${total}/5 –≥—Ä—É–ø–ø —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`, total === 5 ? 'pass' : 'fail');
      updateStatus(total === 5 ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏');

      return total === 5;
    }

    // ========================================================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ========================================================================

    $('#btn-run').on('click', runAllTests);

    $('#btn-clear').on('click', () => {
      $('#console-log').html('<small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞...</small>');
      updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...');
      log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    $('#btn-auto').on('click', async () => {
      $('#btn-auto').prop('disabled', true);
      await runAllTests();
      await sleep(500);
      $('#btn-auto').prop('disabled', false);
    });

    // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    $(document).ready(() => {
      log('‚úÖ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω', 'pass');
      log('‚úÖ validationRules –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'pass');
      updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∞–º');
    });
  </script>
</body>

</html>