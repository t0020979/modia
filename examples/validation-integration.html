<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modia Validation Component - Интеграционный пример</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .field-error-message {
      margin-top: 0.25rem;
      font-size: 0.875em;
    }

    .field_with_errors {
      border: 2px solid #dc3545;
      border-radius: 0.25rem;
      padding: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h1 class="mb-4">Modia Validation Component</h1>

    <!-- Пример 1: Обычная форма -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Пример 1: Обычная форма с разными типами полей</h5>
      </div>
      <div class="card-body">
        <form id="example-form" data-component="validation">
          <div class="form-group mb-3">
            <label class="form-label">Имя *</label>
            <input type="text" name="name" required class="form-control">
          </div>

          <div class="form-group mb-3">
            <label class="form-label">Email *</label>
            <input type="email" name="email" required class="form-control">
          </div>

          <div class="form-group mb-3">
            <label class="form-label">Комментарий</label>
            <textarea name="comment" class="form-control" rows="3"></textarea>
          </div>

          <div class="form-group mb-3">
            <label class="form-label">Участники *</label>
            <select name="members[]" class="form-control" multiple required>
              <option value="cheburashka">Чебурашка</option>
              <option value="crocodile">Крокодил Гена</option>
              <option value="monkey">Обезьяна</option>
              <option value="lion">Лев</option>
            </select>
            <small class="form-text text-muted">Выберите хотя бы одного участника</small>
          </div>

          <!-- Шаблоны ошибок -->
          <div class="error-templates">
            <span class="text-danger" data-rule="required">Обязательное поле</span>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-primary">Отправить</button>
            <button type="button" id="clear-btn" class="btn btn-outline-secondary">Очистить ошибки</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Пример 2: Модалка без формы -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Пример 2: Модальное окно без формы (контейнер на div)</h5>
      </div>
      <div class="card-body">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#characterModal">
          Открыть модалку
        </button>
      </div>
    </div>

    <!-- Модальное окно -->
    <div class="modal fade" id="characterModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Новый персонаж</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <!-- Контейнер на div, а не на форме -->
          <div class="modal-body" data-component="validation">
            <div class="form-group mb-3">
              <label class="form-label">Имя *</label>
              <input type="text" name="character_name" required class="form-control">
            </div>

            <div class="form-group mb-3">
              <label class="form-label">Вид *</label>
              <select name="species" required class="form-control">
                <option value="">Выберите...</option>
                <option value="crocodile">Крокодил</option>
                <option value="lion">Лев</option>
                <option value="monkey">Обезьяна</option>
              </select>
            </div>

            <div class="error-templates">
              <span class="text-danger" data-rule="required">Заполните поле</span>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="button" class="btn btn-primary" id="save-character" data-validate>Сохранить</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Пример 2б: Модальное окно с <form> внутри -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalWithForm">
      Открыть модалку с формой
    </button>

    <div class="modal" id="modalWithForm">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Новый персонаж (с формой)</h5>
          </div>
          <form data-component="validation" class="modal-body">
            <div class="form-group">
              <label>Имя</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Вид</label>
              <select name="species" class="form-control" required>
                <option value="">Выберите...</option>
                <option value="crocodile">Крокодил</option>
                <option value="lion">Лев</option>
              </select>
            </div>

            <div class="error-templates">
              <span class="text-danger" data-rule="required">Заполните поле</span>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
              <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <!-- Пример 3: Скрытое поле с внешним элементом -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Пример 3: Скрытое поле с внешним элементом</h5>
      </div>
      <div class="card-body">
        <form id="hidden-field-form" data-component="validation">
          <div class="form-group mb-3">
            <label class="form-label">Выберите персонажа *</label>

            <!-- Внешний элемент для валидации -->
            <div class="character-selector border p-3 rounded" required data-input-value-source="#character_id"
              style="cursor: pointer;">
              <p id="selected-character">Не выбрано</p>
              <button type="button" class="btn btn-sm btn-outline-primary me-2"
                data-select="cheburashka">Чебурашка</button>
              <button type="button" class="btn btn-sm btn-outline-primary" data-select="crocodile">Крокодил
                Гена</button>
            </div>

            <!-- Скрытое поле с реальным значением -->
            <input type="hidden" id="character_id" name="character_id">
          </div>

          <div class="error-templates">
            <span class="text-danger" data-rule="required">Выберите персонажа</span>
          </div>

          <button type="submit" class="btn btn-primary">Сохранить</button>
        </form>
      </div>
    </div>

    <!-- Пример 4: Массив полей с динамическим добавлением -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Пример 4: Массив полей с динамическим добавлением</h5>
      </div>
      <div class="card-body">
        <form id="dynamic-fields-form" data-component="validation">
          <div class="form-group mb-3">
            <label class="form-label">Теги *</label>
            <div id="tags-container">
              <div class="input-group mb-2">
                <input type="text" name="tags[]" class="form-control" required>
                <button type="button" class="btn btn-danger remove-tag">&times;</button>
              </div>
            </div>

            <button type="button" id="add-tag" class="btn btn-sm btn-outline-primary mb-3">
              <i class="bi bi-plus"></i> Добавить тег
            </button>
          </div>

          <div class="error-templates">
            <span class="text-danger" data-rule="required">Заполните хотя бы одно поле</span>
          </div>

          <button type="submit" class="btn btn-primary">Отправить</button>
        </form>
      </div>
    </div>

    <!-- Статус -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Статус компонентов</h5>
      </div>
      <div class="card-body">
        <pre id="status"></pre>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modia -->
  <script type="module">
    import { ComponentScanner } from '../modia/core.js';
    import { ValidationComponent } from '../modia/components/validation.js';

    // Регистрируем компонент
    ComponentScanner.register(ValidationComponent);

    // Инициализируем
    $(document).ready(() => {
      const instances = ComponentScanner.scan();
      console.log('Modia инициализирован. Найдено компонентов:', instances.length);

      updateStatus(instances);

      // Обработчик кнопки "Очистить ошибки"
      $('#clear-btn').on('click', () => {
        const form = document.getElementById('example-form');
        const validation = ComponentScanner.scan(form)[0];
        if (validation) {
          validation.clearErrors();
        }
      });

      // Обработчик выбора персонажа
      $('[data-select]').on('click', function () {
        const value = $(this).data('select');
        const name = value === 'cheburashka' ? 'Чебурашка' : 'Крокодил Гена';

        $('#selected-character').text(`Выбрано: ${name}`);
        $('#character_id').val(value);

        // Обновляем валидацию
        const form = document.getElementById('hidden-field-form');
        const validation = ComponentScanner.scan(form)[0];
        if (validation) {
          validation.validate();
        }
      });

      // Динамическое добавление тегов
      $('#add-tag').on('click', function () {
        $('#tags-container').append(`
          <div class="input-group mb-2">
            <input type="text" name="tags[]" class="form-control" required>
            <button type="button" class="btn btn-danger remove-tag">&times;</button>
          </div>
        `);

        // Обновляем правила валидации
        const form = document.getElementById('dynamic-fields-form');
        const validation = ComponentScanner.scan(form)[0];
        if (validation) {
          validation.refreshRules();
        }
      });

      // Удаление тега
      $(document).on('click', '.remove-tag', function () {
        $(this).closest('.input-group').remove();

        // Обновляем правила валидации
        const form = document.getElementById('dynamic-fields-form');
        const validation = ComponentScanner.scan(form)[0];
        if (validation) {
          validation.refreshRules();
        }
      });
    });

    function updateStatus(instances) {
      const status = {
        totalComponents: instances.length,
        components: instances.map((comp, i) => ({
          index: i,
          type: comp.constructor.name,
          elemeщеnt: comp.$el[0].tagName,
          hasErrors: comp.fieldValidators.some(v => v.errorRenderer.hasError())
        }))
      };

      $('#status').text(JSON.stringify(status, null, 2));
    }
  </script>
</body>

</html>