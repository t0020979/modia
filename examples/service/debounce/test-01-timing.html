<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Modia ‚Äî –¢–µ—Å—Ç Debounce Service</title>
  <!-- jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <!-- –ü—Ä–∏–º–µ—Ä—ã CSS (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å!) -->
  <link rel="stylesheet" href="../../../examples/examples.css">
</head>

<body>
  <div class="container mt-5">
    <h1>üß™ –¢–µ—Å—Ç Debounce Service</h1>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul>
        <li>–§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –±–µ–∑ –Ω–æ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤</li>
        <li>–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç —Ç–∞–π–º–µ—Ä</li>
        <li>–†–µ–∂–∏–º immediate –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ</li>
        <li>–ö–æ–Ω—Ç–µ–∫—Å—Ç (this) –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
        <li>–û—à–∏–±–∫–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –ª–æ–º–∞—é—Ç —Ä–∞–±–æ—Ç—É —Ç–∞–π–º–µ—Ä–∞</li>
      </ul>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 1: –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 1: –ë–∞–∑–æ–≤—ã–π debounce (–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤)</h3>
      <div class="test-buttons">
        <button id="btn-basic" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
      </div>
      <div id="result-basic" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 2: –†–µ–∂–∏–º immediate -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 2: –†–µ–∂–∏–º immediate (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤)</h3>
      <div class="test-buttons">
        <button id="btn-immediate" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
      </div>
      <div id="result-immediate" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 3: –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 3: –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö</h3>
      <div class="test-buttons">
        <button id="btn-reset" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
      </div>
      <div id="result-reset" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
      <div class="test-buttons">
        <button id="btn-error" class="btn btn-warning">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç (—Å –æ—à–∏–±–∫–æ–π)</button>
      </div>
      <div id="result-error" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 5: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</h3>
      <div class="test-buttons">
        <button id="btn-context" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
      </div>
      <div id="result-context" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥ -->
    <div class="test-section">
      <h3>üìã –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥</h3>
      <div id="console-log" class="console-log bg-light p-3" style="max-height: 200px; overflow-y: auto;">
        <small class="text-muted">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</small>
      </div>
    </div>
  </div>

  <script type="module">
    import { debounce } from '../../../modia/services/debounce.js';

    // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ HTML
    function log(message, type = 'info') {
      const $log = $('#console-log');
      const timestamp = new Date().toLocaleTimeString('ru-RU');
      const color = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-muted';
      $log.append(`<div class="${color}"><small>[${timestamp}] ${message}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[Debounce Test] ${message}`);
    }

    function setResult($el, status, message) {
      $el.removeClass('pending pass fail').addClass(status).text(message);
    }

    // ============================================
    // –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–π debounce
    // ============================================
    $('#btn-basic').on('click', function () {
      const $result = $('#result-basic');
      setResult($result, 'pending', '–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω...');
      log('=== –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–π debounce ===');

      let callCount = 0;
      let executedTime = null;
      let startTime = null;

      const debouncedFn = debounce(() => {
        callCount++;
        executedTime = Date.now();
        const elapsed = executedTime - startTime;
        log(`–§—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞! –ü—Ä–æ—à–ª–æ: ${elapsed}–º—Å`);

        // ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: 200-500–º—Å (—É—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã)
        if (callCount === 1 && elapsed >= 200 && elapsed <= 500) {
          setResult($result, 'pass', `‚úÖ –£—Å–ø–µ—Ö: –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ ${elapsed}–º—Å (–æ–∂–∏–¥–∞–ª–æ—Å—å ~300–º—Å)`);
          log('–¢–µ—Å—Ç 1: PASSED');
        } else {
          setResult($result, 'fail', `‚ùå –û—à–∏–±–∫–∞: –≤—ã–∑–æ–≤–æ–≤=${callCount}, –≤—Ä–µ–º—è=${elapsed}–º—Å`);
          log('–¢–µ—Å—Ç 1: FAILED');
        }
      }, 300);

      startTime = Date.now();

      log('–í—ã–∑–æ–≤ 1');
      debouncedFn();
      log('–í—ã–∑–æ–≤ 2 (—á–µ—Ä–µ–∑ 50–º—Å)');
      setTimeout(() => debouncedFn(), 50);
      log('–í—ã–∑–æ–≤ 3 (—á–µ—Ä–µ–∑ 100–º—Å)');
      setTimeout(() => debouncedFn(), 100);
    });
    // ============================================
    // –¢–µ—Å—Ç 2: –†–µ–∂–∏–º immediate
    // ============================================
    $('#btn-immediate').on('click', function () {
      const $result = $('#result-immediate');
      setResult($result, 'pending', '–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω...');
      log('=== –¢–µ—Å—Ç 2: –†–µ–∂–∏–º immediate ===');

      let callCount = 0;
      const callTimes = [];

      const debouncedFn = debounce(() => {
        callCount++;
        callTimes.push(Date.now());
        log(`–§—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ (–≤—ã–∑–æ–≤ #${callCount})`);
      }, 300, true);

      // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ ‚Äî –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
      log('–í—ã–∑–æ–≤ 1 (–¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)');
      debouncedFn();
      log(`–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ 1: callCount=${callCount}`);

      // –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤ –ø–∞—É–∑–µ ‚Äî –¥–æ–ª–∂–Ω—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
      log('–í—ã–∑–æ–≤ 2 (—á–µ—Ä–µ–∑ 50–º—Å, –¥–æ–ª–∂–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)');
      setTimeout(() => {
        debouncedFn();
        log(`–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ 2: callCount=${callCount}`);
      }, 50);

      log('–í—ã–∑–æ–≤ 3 (—á–µ—Ä–µ–∑ 100–º—Å, –¥–æ–ª–∂–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)');
      setTimeout(() => {
        debouncedFn();
        log(`–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ 3: callCount=${callCount}`);
      }, 100);

      // ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 400–º—Å –¥–æ 500–º—Å ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è later()
      setTimeout(() => {
        log('–í—ã–∑–æ–≤ 4 (–ø–æ—Å–ª–µ –ø–∞—É–∑—ã 500–º—Å, –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å)');
        debouncedFn();
        log(`–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ 4: callCount=${callCount}`);

        setTimeout(() => {
          log(`–§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç: callCount=${callCount}`);
          if (callCount === 2) {
            setResult($result, 'pass', `‚úÖ –£—Å–ø–µ—Ö: 2 –≤—ã–∑–æ–≤–∞ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π + –ø–æ—Å–ª–µ –ø–∞—É–∑—ã)`);
            log('–¢–µ—Å—Ç 2: PASSED');
          } else {
            setResult($result, 'fail', `‚ùå –û—à–∏–±–∫–∞: –≤—ã–∑–æ–≤–æ–≤=${callCount} (–æ–∂–∏–¥–∞–ª–æ—Å—å 2)`);
            log('–¢–µ—Å—Ç 2: FAILED');
          }
        }, 400);
      }, 500);  // ‚Üê –ë—ã–ª–æ 400, —Å—Ç–∞–ª–æ 500
    });
    // ============================================
    // –¢–µ—Å—Ç 3: –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
    // ============================================
    $('#btn-reset').on('click', function () {
      const $result = $('#result-reset');
      setResult($result, 'pending', '–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω...');
      log('=== –¢–µ—Å—Ç 3: –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ ===');

      let callCount = 0;
      const startTime = Date.now();

      const debouncedFn = debounce(() => {
        callCount++;
        const elapsed = Date.now() - startTime;
        log(`–§—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞! –ü—Ä–æ—à–ª–æ: ${elapsed}–º—Å`);
      }, 300);

      // 5 –±—ã—Å—Ç—Ä—ã—Ö –≤—ã–∑–æ–≤–æ–≤
      log('5 –±—ã—Å—Ç—Ä—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∑–∞ 200–º—Å...');
      debouncedFn();
      setTimeout(() => debouncedFn(), 40);
      setTimeout(() => debouncedFn(), 80);
      setTimeout(() => debouncedFn(), 120);
      setTimeout(() => debouncedFn(), 160);

      setTimeout(() => {
        if (callCount === 1) {
          setResult($result, 'pass', '‚úÖ –£—Å–ø–µ—Ö: —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ 1 —Ä–∞–∑ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞');
          log('–¢–µ—Å—Ç 3: PASSED');
        } else {
          setResult($result, 'fail', `‚ùå –û—à–∏–±–∫–∞: –≤—ã–∑–æ–≤–æ–≤=${callCount} (–æ–∂–∏–¥–∞–ª–æ—Å—å 1)`);
          log('–¢–µ—Å—Ç 3: FAILED');
        }
      }, 500);
    });

    // ============================================
    // –¢–µ—Å—Ç 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    // ============================================
    $('#btn-error').on('click', function () {
      const $result = $('#result-error');
      setResult($result, 'pending', '–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω...');
      log('=== –¢–µ—Å—Ç 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ===');

      let errorCaught = false;
      let timerWorks = false;

      // –§—É–Ω–∫—Ü–∏—è —Å –æ—à–∏–±–∫–æ–π
      const errorFn = debounce(() => {
        log('–§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏)...');
        timerWorks = true;
      }, 300);

      // –í—ã–∑—ã–≤–∞–µ–º —Å –æ—à–∏–±–∫–æ–π
      const errorDebounced = debounce(() => {
        log('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏...');
        throw new Error('–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞');
      }, 100);

      errorDebounced();

      setTimeout(() => {
        // –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å
        errorFn();

        setTimeout(() => {
          if (timerWorks) {
            setResult($result, 'pass', '‚úÖ –£—Å–ø–µ—Ö: —Ç–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏');
            log('–¢–µ—Å—Ç 4: PASSED');
          } else {
            setResult($result, 'fail', '‚ùå –û—à–∏–±–∫–∞: —Ç–∞–π–º–µ—Ä —Å–ª–æ–º–∞–ª—Å—è –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏');
            log('–¢–µ—Å—Ç 4: FAILED');
          }
        }, 400);
      }, 150);
    });

    // ============================================
    // –¢–µ—Å—Ç 5: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    // ============================================
    $('#btn-context').on('click', function () {
      const $result = $('#result-context');
      setResult($result, 'pending', '–¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω...');
      log('=== –¢–µ—Å—Ç 5: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã ===');

      const testContext = { name: 'TestObject' };
      let contextCorrect = false;
      let argsCorrect = false;

      const debouncedFn = debounce(function (arg1, arg2) {
        log(`this.name = ${this.name}`);
        log(`arg1 = ${arg1}, arg2 = ${arg2}`);

        contextCorrect = (this.name === 'TestObject');
        argsCorrect = (arg1 === 'hello' && arg2 === 42);
      }, 300);

      // –í—ã–∑–æ–≤ —Å bind –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      const boundFn = debouncedFn.bind(testContext);
      boundFn('hello', 42);

      setTimeout(() => {
        if (contextCorrect && argsCorrect) {
          setResult($result, 'pass', '‚úÖ –£—Å–ø–µ—Ö: –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
          log('–¢–µ—Å—Ç 5: PASSED');
        } else {
          setResult($result, 'fail', `‚ùå –û—à–∏–±–∫–∞: context=${contextCorrect}, args=${argsCorrect}`);
          log('–¢–µ—Å—Ç 5: FAILED');
        }
      }, 400);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    log('Debounce Test Suite –∑–∞–≥—Ä—É–∂–µ–Ω');
    log('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ç–µ—Å—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞');
  </script>
</body>

</html>