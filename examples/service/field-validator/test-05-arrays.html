<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modia ‚Äî –¢–µ—Å—Ç FieldValidator (–ú–∞—Å—Å–∏–≤—ã –ø–æ–ª–µ–π)</title>

  <!-- ‚úÖ jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- ‚úÖ Modia CSS (—Å–∫—Ä—ã–≤–∞–µ—Ç .error-templates) -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <!-- –ü—Ä–∏–º–µ—Ä—ã CSS -->
  <link rel="stylesheet" href="../../../examples/examples.css">

  <style>
    .test-section {
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
      background: #f8f9fa;
    }

    .instruction-box {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }

    .console-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .test-result {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    .test-result.pass {
      background: #d4edda;
      color: #155724;
    }

    .test-result.fail {
      background: #f8d7da;
      color: #721c24;
    }

    .test-result.pending {
      background: #fff3cd;
      color: #856404;
    }

    .auto-test-running {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }

      100% {
        opacity: 1;
      }
    }

    .field-array-item {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h1>üß™ –¢–µ—Å—Ç FieldValidator Service</h1>
    <p class="lead">–ú–∞—Å—Å–∏–≤—ã –ø–æ–ª–µ–π (name='tags[]') + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</p>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result alert alert-info">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul>
        <li><strong>–ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π:</strong> <code>getFieldValue()</code> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç <code>Array&lt;string&gt;</code></li>
        <li><strong>–í–∞–ª–∏–¥–∞—Ü–∏—è:</strong> ¬´—Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ¬ª (–Ω–µ –≤—Å–µ!)</li>
        <li><strong>–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ:</strong> <code>loadRules()</code> –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –ø—Ä–∞–≤–∏–ª</li>
        <li><strong>–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select:</strong> —Ç–æ–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π</li>
        <li><strong>Checkbox –≥—Ä—É–ø–ø—ã:</strong> <code>name='interests[]'</code> —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
      </ul>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π -->
    <div class="test-section" id="section_1">
      <h3>üìç –°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π (name='tags[]')</h3>

      <div class="instruction-box">
        <strong>üìã –†—É—á–Ω–æ–π —Ç–µ—Å—Ç:</strong><br>
        1. –û—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏ ‚Üí –Ω–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí –æ—à–∏–±–∫–∞<br>
        2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –û–î–ù–û –ø–æ–ª–µ ‚Üí –Ω–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí —É—Å–ø–µ—Ö<br>
        3. –ù–∞–∂–º–∏—Ç–µ <code>üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</code> ‚Üí –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å <code>Array&lt;string&gt;</code><br>
        4. –ù–∞–∂–º–∏—Ç–µ <code>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</code> ‚Üí –Ω–æ–≤–æ–µ –ø–æ–ª–µ –ø–æ—è–≤–∏—Ç—Å—è
      </div>

      <form id="form-arrays" novalidate>
        <div class="form-group" id="fg-tags">
          <label>–¢–µ–≥–∏ * (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω)</label>
          <div id="tags-container">
            <div class="field-array-item">
              <input type="text" name="tags[]" class="form-control" placeholder="–¢–µ–≥ 1" required>
            </div>
            <div class="field-array-item">
              <input type="text" name="tags[]" class="form-control" placeholder="–¢–µ–≥ 2" required>
            </div>
            <div class="field-array-item">
              <input type="text" name="tags[]" class="form-control" placeholder="–¢–µ–≥ 3" required>
            </div>
          </div>

          <button type="button" id="btn-add-tag" class="btn btn-sm btn-outline-primary mt-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
        </div>

        <div class="error-templates">
          <span class="text-danger" data-rule="required">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ</span>
        </div>
      </form>

      <div class="test-buttons mt-3">
        <button id="btn_validate_arr" class="btn btn-primary">üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btn_clear_arr" class="btn btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É</button>
        <button id="btn_check_value_arr" class="btn btn-info">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</button>
      </div>

      <div id="result_1" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select -->
    <div class="test-section" id="section_2">
      <h3>üìç –°–µ–∫—Ü–∏—è 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select (multiple)</h3>

      <div class="instruction-box">
        <strong>üìã –†—É—á–Ω–æ–π —Ç–µ—Å—Ç:</strong><br>
        1. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (Ctrl/Cmd + –∫–ª–∏–∫)<br>
        2. –ù–∞–∂–º–∏—Ç–µ <code>üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</code> ‚Üí –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å <code>Array&lt;string&gt;</code><br>
        3. –ù–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å <code>true</code><br>
        4. –°–Ω–∏–º–∏—Ç–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Üí –Ω–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí –æ—à–∏–±–∫–∞
      </div>

      <form id="form-multi-select" novalidate>
        <div class="form-group" id="fg-select">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏ * (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</label>
          <select id="tags-select" name="tags[]" multiple required class="form-control" size="4">
            <option value="tag1">–¢–µ–≥ 1</option>
            <option value="tag2">–¢–µ–≥ 2</option>
            <option value="tag3">–¢–µ–≥ 3</option>
            <option value="tag4">–¢–µ–≥ 4</option>
          </select>
          <small class="form-text text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl/Cmd –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</small>
        </div>

        <div class="error-templates">
          <span class="text-danger" data-rule="required">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–≥</span>
        </div>
      </form>

      <div class="test-buttons mt-3">
        <button id="btn_check_value_select" class="btn btn-info">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</button>
        <button id="btn_validate_select" class="btn btn-primary">üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btn_clear_select" class="btn btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É</button>
      </div>

      <div id="result_2" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 3: Checkbox –≥—Ä—É–ø–ø—ã -->
    <div class="test-section" id="section_3">
      <h3>üìç –°–µ–∫—Ü–∏—è 3: Checkbox –≥—Ä—É–ø–ø—ã (name='interests[]')</h3>

      <div class="instruction-box">
        <strong>üìã –†—É—á–Ω–æ–π —Ç–µ—Å—Ç:</strong><br>
        1. –û—Ç–º–µ—Ç—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–∫–±–æ–∫—Å–æ–≤<br>
        2. –ù–∞–∂–º–∏—Ç–µ <code>üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</code> ‚Üí –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å <code>Array&lt;string&gt;</code><br>
        3. –ù–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å <code>true</code><br>
        4. –°–Ω–∏–º–∏—Ç–µ –≤—Å–µ –≥–∞–ª–æ—á–∫–∏ ‚Üí –Ω–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí –æ—à–∏–±–∫–∞
      </div>

      <form id="form-checkboxes" novalidate>
        <div class="form-group" id="fg-checkboxes">
          <label>–ò–Ω—Ç–µ—Ä–µ—Å—ã * (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω)</label>
          <div class="form-check">
            <input type="checkbox" name="interests[]" id="interest-1" value="programming" required
              class="form-check-input">
            <label class="form-check-label" for="interest-1">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
          </div>
          <div class="form-check">
            <input type="checkbox" name="interests[]" id="interest-2" value="design" required class="form-check-input">
            <label class="form-check-label" for="interest-2">–î–∏–∑–∞–π–Ω</label>
          </div>
          <div class="form-check">
            <input type="checkbox" name="interests[]" id="interest-3" value="marketing" required
              class="form-check-input">
            <label class="form-check-label" for="interest-3">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</label>
          </div>
        </div>

        <div class="error-templates">
          <span class="text-danger" data-rule="required">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å</span>
        </div>
      </form>

      <div class="test-buttons mt-3">
        <button id="btn_check_value_cb" class="btn btn-info">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</button>
        <button type='submit' id="btn_validate_cb" class="btn btn-primary">üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btn_clear_cb" class="btn btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É</button>
      </div>

      <div id="result_3" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª -->
    <div class="test-section" id="section_4">
      <h3>üìç –°–µ–∫—Ü–∏—è 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª (loadRules)</h3>

      <div class="instruction-box">
        <strong>üìã –†—É—á–Ω–æ–π —Ç–µ—Å—Ç:</strong><br>
        1. –ù–∞–∂–º–∏—Ç–µ <code>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</code> –≤ –°–µ–∫—Ü–∏–∏ 1<br>
        2. –ù–∞–∂–º–∏—Ç–µ <code>üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞</code> ‚Üí –∫—ç—à –ø—Ä–∞–≤–∏–ª –æ–±–Ω–æ–≤–∏—Ç—Å—è<br>
        3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–≤–æ–µ –ø–æ–ª–µ ‚Üí –Ω–∞–∂–º–∏—Ç–µ <code>üìù –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</code> ‚Üí —É—Å–ø–µ—Ö
      </div>

      <div class="test-buttons mt-3">
        <button id="btn_refresh_rules" class="btn btn-info">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞</button>
        <button id="btn_check_rules_count" class="btn btn-secondary">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª</button>
      </div>

      <div id="result_4" class="test-result pending">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ-—Ç–µ—Å—Ç–∞ -->
    <div class="test-buttons mt-4">
      <button id="btn_auto_test_all" class="btn btn-success btn-lg">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-—Ç–µ—Å—Ç –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π</button>
      <button id="btn_stop_test" class="btn btn-danger btn-lg">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="auto_test_status" class="alert alert-info mt-3" style="display: none;">
      –°—Ç–∞—Ç—É—Å: <span id="auto_test_status_text">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥ -->
    <div class="console-log" id="console-log">
      <div class="text-muted"><small>[00:00:00] –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–≥–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞...</small></div>
    </div>

    <div class="test-buttons mt-2">
      <button id="btn_clear_log" class="btn btn-sm btn-secondary">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="mt-4">
      <a href="test-04-hidden-fields.html" class="btn btn-outline-secondary">[‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ—Å—Ç: –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è]</a>
      <span class="ml-2 text-muted">[–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç FieldValidator ‚úÖ]</span>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
  <script type="module">
    import { FieldValidator } from '../../../modia/services/field-validator.js';
    import { FieldErrorRenderer } from '../../../modia/services/field-error-renderer.js';
    import { logger } from '../../../modia/services/logger.js';

    // ========================================================================
    // Mock Rules ‚Äî –û–î–ò–ù –æ–±—ä–µ–∫—Ç –¥–ª—è –í–°–ï–• –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ (—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π)
    // ========================================================================
    const mockValidationRules = [
      {
        name: 'required',
        selector: '[required]',
        defaultMessage: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ',
        validate($field, validator) {
          const value = validator.getFieldValue();

          console.log('[RULE required] ====== –ù–ê–ß–ê–õ–û –ü–†–û–í–ï–†–ö–ò ======');
          console.log('[RULE required] getFieldValue() –≤–µ—Ä–Ω—É–ª–æ:', value);

          // –î–ª—è –º–∞—Å—Å–∏–≤–∞ –ø–æ–ª–µ–π ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
          if (Array.isArray(value)) {
            console.log('[RULE required] –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞ –∏–∑', value.length, '—ç–ª–µ–º–µ–Ω—Ç–æ–≤');

            const hasFilledValue = value.some(val => {
              // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
              if (val === null || val === undefined) return false;
              if (typeof val === 'string') return val.trim() !== '';
              return false;
            });

            console.log('[RULE required] hasFilledValue:', hasFilledValue);
            console.log('[RULE required] ====== –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò ======');

            return hasFilledValue ? true : { valid: false, params: {} };
          }

          // –î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–ª—è
          console.log('[RULE required] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–ª—è');
          const isValid = value !== null && value !== undefined && value.toString().trim() !== '';
          console.log('[RULE required] isValid:', isValid);
          console.log('[RULE required] ====== –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò ======');

          return isValid ? true : { valid: false, params: {} };
        }
      }
    ];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let validators = {};
    let renderers = {};
    let autoTestRunning = false;

    // ========================================================================
    // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    // ========================================================================
    function log(message, type = 'info') {
      const $log = $('#console-log');
      const timestamp = new Date().toLocaleTimeString('ru-RU');
      const color = type === 'error' ? 'text-danger'
        : type === 'success' ? 'text-success'
          : type === 'warn' ? 'text-warning'
            : 'text-muted';
      $log.append(`<div class="${color}"><small>[${timestamp}] ${message}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[FieldValidator Test] ${message}`);
    }

    // ========================================================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ ‚Äî –í–°–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç –û–î–ò–ù –æ–±—ä–µ–∫—Ç mockValidationRules
    // ========================================================================
    function initValidators() {
      // –°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
      const $tags = $('input[name="tags[]"]');
      renderers.arr = new FieldErrorRenderer($tags.first());
      validators.arr = new FieldValidator($tags, $tags.first(), $('#form-arrays'), mockValidationRules, renderers.arr);
      // ‚Üë –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: mockValidationRules (–û–î–ò–ù –æ–±—ä–µ–∫—Ç)

      // –°–µ–∫—Ü–∏—è 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select
      const $select = $('#tags-select');
      renderers.select = new FieldErrorRenderer($select);
      validators.select = new FieldValidator($select, $select, $('#form-multi-select'), mockValidationRules, renderers.select);
      // ‚Üë –¢–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç mockValidationRules

      // –°–µ–∫—Ü–∏—è 3: Checkbox –≥—Ä—É–ø–ø—ã
      const $checkboxes = $('input[name="interests[]"]');
      renderers.cb = new FieldErrorRenderer($checkboxes.first());
      validators.cb = new FieldValidator($checkboxes, $checkboxes.first(), $('#form-checkboxes'), mockValidationRules, renderers.cb);
      // ‚Üë –¢–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç mockValidationRules

      log('–í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }

    // ========================================================================
    // –°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
    // ========================================================================
    $('#btn_validate_arr').on('click', function () {
      const isValid = validators.arr.validate();
      const value = validators.arr.getFieldValue();
      $('#result_1')
        .removeClass('pending pass fail')
        .addClass(isValid ? 'pass' : 'fail')
        .text(`validate(): ${isValid} | getFieldValue(): ${JSON.stringify(value)}`);
      log(`–ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π: validate() = ${isValid}, value = ${JSON.stringify(value)}`, isValid ? 'success' : 'error');
    });

    $('#btn_clear_arr').on('click', function () {
      validators.arr.clearError();
      $('#result_1').addClass('pass').text('–û—à–∏–±–∫–∞ –æ—á–∏—â–µ–Ω–∞');
      log('–ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π: clearError()', 'info');
    });

    $('#btn_check_value_arr').on('click', function () {
      const value = validators.arr.getFieldValue();
      const isArray = Array.isArray(value);
      $('#result_1')
        .addClass('pass')
        .text(`getFieldValue(): ${JSON.stringify(value)} (type: ${isArray ? 'Array' : 'string'})`);
      log(`–ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π: getFieldValue() = ${JSON.stringify(value)} (${isArray ? 'Array' : 'string'})`, 'info');
    });

    $('#btn-add-tag').on('click', function () {
      const count = $('#tags-container .field-array-item').length + 1;
      $('#tags-container').append(`
        <div class="field-array-item">
          <input type="text" name="tags[]" class="form-control" placeholder="–¢–µ–≥ ${count}">
        </div>
      `);
      log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ #${count}`, 'info');
    });

    // ========================================================================
    // –°–µ–∫—Ü–∏—è 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select
    // ========================================================================
    $('#btn_check_value_select').on('click', function () {
      const value = validators.select.getFieldValue();
      const isArray = Array.isArray(value);
      $('#result_2')
        .removeClass('pending pass fail')
        .addClass('pass')
        .text(`getFieldValue(): ${JSON.stringify(value)} (type: ${isArray ? 'Array' : 'string'})`);
      log(`Multi-select: getFieldValue() = ${JSON.stringify(value)} (${isArray ? 'Array' : 'string'})`, 'info');
    });

    $('#btn_validate_select').on('click', function () {
      const isValid = validators.select.validate();
      $('#result_2')
        .removeClass('pending pass fail')
        .addClass(isValid ? 'pass' : 'fail')
        .text(`validate(): ${isValid}`);
      log(`Multi-select: validate() = ${isValid}`, isValid ? 'success' : 'error');
    });

    $('#btn_clear_select').on('click', function () {
      validators.select.clearError();
      $('#result_2').addClass('pass').text('–û—à–∏–±–∫–∞ –æ—á–∏—â–µ–Ω–∞');
      log('Multi-select: clearError()', 'info');
    });

    // ========================================================================
    // –°–µ–∫—Ü–∏—è 3: Checkbox –≥—Ä—É–ø–ø—ã
    // ========================================================================
    $('#btn_check_value_cb').on('click', function () {
      const value = validators.cb.getFieldValue();
      const isArray = Array.isArray(value);
      $('#result_3')
        .removeClass('pending pass fail')
        .addClass('pass')
        .text(`getFieldValue(): ${JSON.stringify(value)} (type: ${isArray ? 'Array' : 'string'})`);
      log(`Checkbox: getFieldValue() = ${JSON.stringify(value)} (${isArray ? 'Array' : 'string'})`, 'info');
    });

    $('#btn_validate_cb').on('click', function () {
      const isValid = validators.cb.validate();
      $('#result_3')
        .removeClass('pending pass fail')
        .addClass(isValid ? 'pass' : 'fail')
        .text(`validate(): ${isValid}`);
      log(`Checkbox: validate() = ${isValid}`, isValid ? 'success' : 'error');
    });

    $('#btn_clear_cb').on('click', function () {
      validators.cb.clearError();
      $('#result_3').addClass('pass').text('–û—à–∏–±–∫–∞ –æ—á–∏—â–µ–Ω–∞');
      log('Checkbox: clearError()', 'info');
    });

    // ========================================================================
    // –°–µ–∫—Ü–∏—è 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
    // ========================================================================
    $('#btn_refresh_rules').on('click', function () {
      validators.arr.loadRules();
      const ruleCount = validators.arr.applicableRules ? validators.arr.applicableRules.length : 0;
      $('#result_4').addClass('pass').text(`–ü—Ä–∞–≤–∏–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${ruleCount}`);
      log(`loadRules() –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${ruleCount} –ø—Ä–∞–≤–∏–ª`, 'info');
    });

    $('#btn_check_rules_count').on('click', function () {
      const ruleCount = validators.arr.applicableRules ? validators.arr.applicableRules.length : 0;
      const fieldCount = $('input[name="tags[]"]').length;
      $('#result_4').addClass('pass').text(`–ü—Ä–∞–≤–∏–ª: ${ruleCount} | –ü–æ–ª–µ–π: ${fieldCount}`);
      log(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ø—Ä–∞–≤–∏–ª=${ruleCount}, –ø–æ–ª–µ–π=${fieldCount}`, 'info');
    });

    // ========================================================================
    // –ê–≤—Ç–æ-—Ç–µ—Å—Ç
    // ========================================================================
    async function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function runAutoTestAll() {
      if (autoTestRunning) return;
      autoTestRunning = true;

      $('#auto_test_status').show();
      $('#auto_test_status_text').text('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...');

      log('=== –ó–ê–ü–£–°–ö –ê–í–¢–û-–¢–ï–°–¢–ê ===', 'info');

      // –°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π (–ø—É—Å—Ç—ã–µ ‚Üí –æ—à–∏–±–∫–∞)
      $('#auto_test_status_text').text('–°–µ–∫—Ü–∏—è 1: –ú–∞—Å—Å–∏–≤ –ø–æ–ª–µ–π (–ø—É—Å—Ç—ã–µ)...');
      $('#section_1').addClass('auto-test-running');
      await sleep(500);
      $('#btn_validate_arr').click();
      await sleep(800);

      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ–¥–Ω–æ –ø–æ–ª–µ
      $('#auto_test_status_text').text('–°–µ–∫—Ü–∏—è 1: –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–¥–Ω–æ –ø–æ–ª–µ...');
      $('input[name="tags[]"]').first().val('–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–≥');
      await sleep(300);
      $('#btn_validate_arr').click();
      await sleep(800);
      $('#btn_check_value_arr').click();
      await sleep(500);
      $('#section_1').removeClass('auto-test-running');

      // –°–µ–∫—Ü–∏—è 2: Multi-select
      $('#auto_test_status_text').text('–°–µ–∫—Ü–∏—è 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select...');
      $('#section_2').addClass('auto-test-running');
      await sleep(500);
      $('#tags-select').val(['tag1', 'tag3']);
      await sleep(300);
      $('#btn_check_value_select').click();
      await sleep(800);
      $('#btn_validate_select').click();
      await sleep(500);
      $('#section_2').removeClass('auto-test-running');

      // –°–µ–∫—Ü–∏—è 3: Checkbox
      $('#auto_test_status_text').text('–°–µ–∫—Ü–∏—è 3: Checkbox –≥—Ä—É–ø–ø—ã...');
      $('#section_3').addClass('auto-test-running');
      await sleep(500);
      $('#interest-1').prop('checked', true);
      $('#interest-2').prop('checked', true);
      await sleep(300);
      $('#btn_check_value_cb').click();
      await sleep(800);
      $('#btn_validate_cb').click();
      await sleep(500);
      $('#section_3').removeClass('auto-test-running');

      // –°–µ–∫—Ü–∏—è 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      $('#auto_test_status_text').text('–°–µ–∫—Ü–∏—è 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
      $('#section_4').addClass('auto-test-running');
      await sleep(500);
      $('#btn-add-tag').click();
      await sleep(300);
      $('#btn_refresh_rules').click();
      await sleep(800);
      $('#btn_check_rules_count').click();
      await sleep(500);
      $('#section_4').removeClass('auto-test-running');

      $('#auto_test_status_text').text('‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!');
      $('#auto_test_status').addClass('alert-success');
      log('=== –ê–í–¢–û-–¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù ===', 'success');

      autoTestRunning = false;
    }

    $('#btn_auto_test_all').on('click', runAutoTestAll);

    $('#btn_stop_test').on('click', function () {
      autoTestRunning = false;
      $('#auto_test_status').hide();
      $('.auto-test-running').removeClass('auto-test-running');
      log('–ê–≤—Ç–æ—Ç–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warn');
    });

    $('#btn_clear_log').on('click', function () {
      $('#console-log').html('<div class="text-muted"><small>[00:00:00] –õ–æ–≥ –æ—á–∏—â–µ–Ω...</small></div>');
      log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    // ========================================================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // ========================================================================
    $(document).ready(function () {
      initValidators();
      log('–¢–µ—Å—Ç FieldValidator –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    });
  </script>
</body>

</html>