<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modia ‚Äî –¢–µ—Å—Ç FieldErrorRenderer (Legacy —à–∞–±–ª–æ–Ω—ã)</title>

  <!-- jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Modia CSS -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <!-- –ü—Ä–∏–º–µ—Ä—ã CSS -->
  <link rel="stylesheet" href="../../examples.css">

  <style>
    .template-indicator {
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      display: inline-block;
      margin: 5px 0;
    }

    .template-preserved {
      background: #d4edda;
      color: #155724;
    }

    .template-removed {
      background: #f8d7da;
      color: #721c24;
    }

    .marker-output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      margin: 10px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è legacy —à–∞–±–ª–æ–Ω–æ–≤ */
    .error-template {
      border: 2px dashed #28a745;
      padding: 10px;
      margin: 10px 0;
      background: #f0fff0;
    }

    .error-template.invisible {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h1>üß™ –¢–µ—Å—Ç FieldErrorRenderer Service</h1>
    <p class="text-muted">Legacy —à–∞–±–ª–æ–Ω—ã + –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</p>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul>
        <li><code>.error-template</code> –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ <code>clearError()</code></li>
        <li>–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è, —à–∞–±–ª–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</li>
        <li><code>preserveTemplates: true</code> ‚Äî —à–∞–±–ª–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</li>
        <li><code>preserveTemplates: false</code> ‚Äî —É–¥–∞–ª—è–µ—Ç—Å—è –≤—Å—ë</li>
        <li>Plain text –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ <code>&lt;span&gt;</code> —Å <code>logger.warn()</code></li>
        <li>–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: <code>logger.info()</code> –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –∏ –æ—á–∏—Å—Ç–∫–µ</li>
      </ul>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 1: Legacy —à–∞–±–ª–æ–Ω #error_span -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 1: Legacy —à–∞–±–ª–æ–Ω #error_span</h3>

      <div class="form-group" id="form_legacy_1">
        <label for="email_legacy">Email *</label>
        <input type="email" id="email_legacy" class="form-control" placeholder="test@example.com">

        <!-- Legacy —à–∞–±–ª–æ–Ω (–Ω–µ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª—è—Ç—å—Å—è) -->
        <div id="error_span" class="invisible error-template">
          <span class="text-danger">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</span>
        </div>
      </div>

      <div class="mt-2">
        <span class="template-indicator template-preserved" id="status_legacy_1">–®–∞–±–ª–æ–Ω: —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_legacy_1">üìù renderError()</button>
        <button class="btn btn-secondary" id="btn_clear_legacy_1">üóëÔ∏è clearError()</button>
        <button class="btn btn-info" id="btn_check_legacy_1">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      </div>

      <div class="mt-3">
        <div class="marker-output" id="output_legacy_1">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 2: Legacy —à–∞–±–ª–æ–Ω #format-error-span -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 2: Legacy —à–∞–±–ª–æ–Ω #format-error-span</h3>

      <div class="form-group" id="form_legacy_2">
        <label for="phone_legacy">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
        <input type="tel" id="phone_legacy" class="form-control" placeholder="+7 (___) ___-__-__">

        <!-- Legacy —à–∞–±–ª–æ–Ω (–Ω–µ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª—è—Ç—å—Å—è) -->
        <div id="format-error-span" class="invisible error-template">
          <span class="text-danger">–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>
        </div>
      </div>

      <div class="mt-2">
        <span class="template-indicator template-preserved" id="status_legacy_2">–®–∞–±–ª–æ–Ω: —Å–æ—Ö—Ä–∞–Ω—ë–Ω</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_legacy_2">üìù renderError()</button>
        <button class="btn btn-secondary" id="btn_clear_legacy_2">üóëÔ∏è clearError(preserveTemplates: true)</button>
        <button class="btn btn-warning" id="btn_clear_all_legacy_2">üóëÔ∏è clearError(preserveTemplates: false)</button>
        <button class="btn btn-info" id="btn_check_legacy_2">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      </div>

      <div class="mt-3">
        <div class="marker-output" id="output_legacy_2">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 3: Plain text wrapping -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 3: Plain text wrapping (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞)</h3>

      <div class="form-group" id="form_legacy_3">
        <label for="name_legacy">–ò–º—è *</label>
        <input type="text" id="name_legacy" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
      </div>

      <div class="mt-2">
        <span class="template-indicator template-preserved" id="status_legacy_3">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_text_legacy_3">üìù renderError("–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏")</button>
        <button class="btn btn-primary" id="btn_render_html_legacy_3">üìù
          renderError("&lt;span&gt;HTML&lt;/span&gt;")</button>
        <button class="btn btn-info" id="btn_check_legacy_3">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ë—Ä—Ç–∫—É</button>
      </div>

      <div class="mt-3">
        <div class="marker-output" id="output_legacy_3">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</h3>

      <div class="form-group" id="form_legacy_4">
        <label for="debug_legacy">Debug –ø–æ–ª–µ *</label>
        <input type="text" id="debug_legacy" class="form-control">
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_debug_legacy_4">üìù renderError() + –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏</button>
        <button class="btn btn-secondary" id="btn_clear_debug_legacy_4">üóëÔ∏è clearError() + –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏</button>
      </div>

      <div class="mt-3">
        <div class="marker-output" id="output_legacy_4">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥ -->
    <div class="test-section">
      <h3>üìã –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥</h3>
      <div class="event-log" id="console-log" style="max-height: 300px;"></div>
      <div class="test-buttons">
        <button class="btn btn-secondary" id="btn_clear_log">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>
    </div>

    <hr>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∞–º -->
    <div class="test-buttons">
      <a href="test-02-styles.html" class="btn btn-outline-secondary">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ—Å—Ç</a>
      <a href="test-04-logging.html" class="btn btn-outline-primary">–°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí</a>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å!) -->
  <script type="module">
    import { FieldErrorRenderer } from '../../../modia/services/field-error-renderer.js';
    import { logger } from '../../../modia/services/logger.js';

    // ========================================
    // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    // ========================================
    function logToPage(message, type = 'info') {
      const $log = $('#console-log');
      const timestamp = new Date().toLocaleTimeString('ru-RU');
      const color = type === 'error' ? 'text-danger'
        : type === 'success' ? 'text-success'
          : 'text-muted';
      $log.append(`<div class="${color}"><small>[${timestamp}] ${message}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[FieldErrorRenderer Test] ${message}`);
    }

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç logger.info/warn/error –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const originalInfo = logger.info;
    const originalWarn = logger.warn;
    const originalError = logger.error;

    logger.info = function (message, context) {
      logToPage(`[INFO] [${context || 'Test'}] ${message}`, 'info');
      originalInfo.call(logger, message, context);
    };

    logger.warn = function (message, context) {
      logToPage(`[WARN] [${context || 'Test'}] ${message}`, 'error');
      originalWarn.call(logger, message, context);
    };

    logger.error = function (message, context) {
      logToPage(`[ERROR] [${context || 'Test'}] ${message}`, 'error');
      originalError.call(logger, message, context);
    };

    // ========================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–µ—Ä–æ–≤
    // ========================================
    const rendererLegacy1 = new FieldErrorRenderer($('#email_legacy'));
    const rendererLegacy2 = new FieldErrorRenderer($('#phone_legacy'));
    const rendererLegacy3 = new FieldErrorRenderer($('#name_legacy'));
    const rendererLegacy4 = new FieldErrorRenderer($('#debug_legacy'));

    logToPage('FieldErrorRenderer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');

    // ========================================
    // –°–µ–∫—Ü–∏—è 1: Legacy —à–∞–±–ª–æ–Ω #error_span
    // ========================================
    $('#btn_render_legacy_1').on('click', function () {
      rendererLegacy1.renderError('<span class="text-danger">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</span>');
      logToPage('renderError() –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_clear_legacy_1').on('click', function () {
      rendererLegacy1.clearError(true); // preserveTemplates: true
      logToPage('clearError(true) –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_check_legacy_1').on('click', function () {
      const $template = $('#error_span');
      const templateExists = $template.length > 0;
      const templateVisible = $template.is(':visible');
      const dynamicErrors = $('[data-modia-error^="form_legacy_1:"]').length;

      const output = {
        'template.exists': templateExists,
        'template.visible': templateVisible,
        'template.class': $template.attr('class'),
        'dynamicErrors': dynamicErrors,
        'preserved': templateExists ? '‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '‚ùå –®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω'
      };

      $('#output_legacy_1').text(JSON.stringify(output, null, 2));
      $('#status_legacy_1').text(templateExists ? '–®–∞–±–ª–æ–Ω: —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–®–∞–±–ª–æ–Ω: –£–î–ê–õ–ï–ù')
        .removeClass('template-preserved template-removed')
        .addClass(templateExists ? 'template-preserved' : 'template-removed');

      logToPage(`–®–∞–±–ª–æ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${templateExists ? '—Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–£–î–ê–õ–ï–ù'}`, templateExists ? 'success' : 'error');
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 2: Legacy —à–∞–±–ª–æ–Ω #format-error-span
    // ========================================
    $('#btn_render_legacy_2').on('click', function () {
      rendererLegacy2.renderError('<span class="text-danger">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</span>');
      logToPage('renderError() –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_clear_legacy_2').on('click', function () {
      rendererLegacy2.clearError(true); // preserveTemplates: true
      logToPage('clearError(true) –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_clear_all_legacy_2').on('click', function () {
      rendererLegacy2.clearError(false); // preserveTemplates: false
      logToPage('clearError(false) –≤—ã–∑–≤–∞–Ω - —É–¥–∞–ª—è–µ—Ç –≤—Å—ë', 'warn');
    });

    $('#btn_check_legacy_2').on('click', function () {
      const $template = $('#format-error-span');
      const templateExists = $template.length > 0;
      const dynamicErrors = $('[data-modia-error^="form_legacy_2:"]').length;

      const output = {
        'template.exists': templateExists,
        'dynamicErrors': dynamicErrors,
        'preserved': templateExists ? '‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '‚ùå –®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω'
      };

      $('#output_legacy_2').text(JSON.stringify(output, null, 2));
      $('#status_legacy_2').text(templateExists ? '–®–∞–±–ª–æ–Ω: —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–®–∞–±–ª–æ–Ω: –£–î–ê–õ–ï–ù')
        .removeClass('template-preserved template-removed')
        .addClass(templateExists ? 'template-preserved' : 'template-removed');

      logToPage(`–®–∞–±–ª–æ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${templateExists ? '—Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–£–î–ê–õ–ï–ù'}`, templateExists ? 'success' : 'error');
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 3: Plain text wrapping
    // ========================================
    $('#btn_render_text_legacy_3').on('click', function () {
      rendererLegacy3.renderError('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ HTML');
      $('#status_legacy_3').text('Plain text –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      logToPage('renderError("–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏") –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_render_html_legacy_3').on('click', function () {
      rendererLegacy3.renderError('<span class="text-danger">HTML –æ—à–∏–±–∫–∞</span>');
      $('#status_legacy_3').text('HTML –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      logToPage('renderError("<span>...</span>") –≤—ã–∑–≤–∞–Ω', 'info');
    });

    $('#btn_check_legacy_3').on('click', function () {
      const $error = $('[data-modia-error^="form_legacy_3:"]').first();

      if ($error.length) {
        const output = {
          'error.exists': true,
          'error.tagName': $error[0].tagName,
          'error.class': $error.attr('class'),
          'error.html': $error.html(),
          'error.outerHTML': $error[0].outerHTML,
          'wrapped': $error[0].tagName === 'SPAN' ? '‚úÖ –¢–µ–∫—Å—Ç –æ–±—ë—Ä–Ω—É—Ç –≤ SPAN' : '‚ÑπÔ∏è HTML –∫–∞–∫ –µ—Å—Ç—å'
        };

        $('#output_legacy_3').text(JSON.stringify(output, null, 2));
        logToPage(`–û–±—ë—Ä—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: ${$error[0].tagName}`, 'success');
      } else {
        $('#output_legacy_3').text('–û—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ renderError() —Å–Ω–∞—á–∞–ª–∞.');
        logToPage('–û—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
      }
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    // ========================================
    $('#btn_render_debug_legacy_4').on('click', function () {
      rendererLegacy4.renderError('<span class="text-danger">–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞</span>');
      logToPage('renderError() –≤—ã–∑–≤–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤', 'info');
    });

    $('#btn_clear_debug_legacy_4').on('click', function () {
      rendererLegacy4.clearError(true);
      logToPage('clearError() –≤—ã–∑–≤–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤', 'info');
    });

    $('#btn_check_debug_legacy_4').on('click', function () {
      const output = {
        'note': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –ª–æ–≥ –≤—ã—à–µ',
        'expected': [
          '[INFO] [FieldErrorRenderer] –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞: debug_legacy ‚Üí ...',
          '[INFO] [FieldErrorRenderer] –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫: debug_legacy (preserveTemplates: true)'
        ]
      };

      $('#output_legacy_4').text(JSON.stringify(output, null, 2));
    });

    // ========================================
    // –£—Ç–∏–ª–∏—Ç—ã
    // ========================================
    $('#btn_clear_log').on('click', function () {
      $('#console-log').empty();
      logToPage('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    // –ù–∞—á–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logToPage('–¢–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    logToPage('–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ logger', 'info');
  </script>
</body>

</html>