<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modia ‚Äî –¢–µ—Å—Ç FieldErrorRenderer (–ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä)</title>

  <!-- jQuery CDN (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- Bootstrap 4 CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Modia CSS -->
  <link rel="stylesheet" href="../../../modia/modia.css">

  <!-- –ü—Ä–∏–º–µ—Ä—ã CSS -->
  <link rel="stylesheet" href="../../examples.css">

  <style>
    .test-field-container {
      border: 2px solid #007bff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .error-status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 150px;
    }

    .error-status.has-error {
      background: #f8d7da;
      color: #721c24;
    }

    .error-status.no-error {
      background: #d4edda;
      color: #155724;
    }

    .marker-output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      margin: 10px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h1>üß™ –¢–µ—Å—Ç FieldErrorRenderer Service</h1>
    <p class="text-muted">–ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä + –æ—á–∏—Å—Ç–∫–∞ + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å</p>

    <!-- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="expected-result">
      <h4>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
      <ul>
        <li><code>renderError()</code> –≤—Å—Ç–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É –≤ DOM</li>
        <li><code>clearError()</code> —É–¥–∞–ª—è–µ—Ç –æ—à–∏–±–∫—É</li>
        <li><code>hasError()</code> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç <code>true/false</code> –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
        <li>–ü–æ–≤—Ç–æ—Ä–Ω—ã–π <code>renderError()</code> –æ—á–∏—â–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ—à–∏–±–∫—É (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)</li>
        <li>–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ <code>.form-group</code> (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)</li>
        <li>–ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî fallback: –ø–æ—Å–ª–µ –ø–æ–ª—è</li>
        <li>–ê—Ç—Ä–∏–±—É—Ç <code>data-modia-error="containerId:fieldId"</code> –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è</li>
        <li>–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: <code>logger.info()</code> –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –∏ –æ—á–∏—Å—Ç–∫–µ</li>
      </ul>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 1: –ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 1: –ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º)</h3>

      <div class="form-group" id="form_1">
        <label for="email">Email *</label>
        <input type="email" id="email" class="form-control" placeholder="test@example.com">
        <!-- –û—à–∏–±–∫–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å—é–¥–∞ -->
      </div>

      <div class="mt-3">
        <span class="error-status no-error" id="status_1">hasError(): false</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_1">üìù renderError()</button>
        <button class="btn btn-secondary" id="btn_clear_1">üóëÔ∏è clearError()</button>
        <button class="btn btn-info" id="btn_check_1">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å hasError()</button>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 2: –†–µ–Ω–¥–µ—Ä –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (fallback) -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 2: Fallback (–±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)</h3>

      <input type="text" id="phone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <!-- –û—à–∏–±–∫–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–ª—è (–Ω–µ—Ç .form-group) -->

      <div class="mt-3">
        <span class="error-status no-error" id="status_2">hasError(): false</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_2">üìù renderError()</button>
        <button class="btn btn-secondary" id="btn_clear_2">üóëÔ∏è clearError()</button>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 3: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 3: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä)</h3>

      <div class="form-group" id="form_2">
        <label for="password">–ü–∞—Ä–æ–ª—å *</label>
        <input type="password" id="password" class="form-control">
      </div>

      <div class="mt-3">
        <span class="error-status no-error" id="status_3">–û—à–∏–±–æ–∫ –≤ DOM: 0</span>
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_3">üìù renderError() √ó 3 —Ä–∞–∑–∞</button>
        <button class="btn btn-info" id="btn_count_3">üîç –ü–æ—Å—á–∏—Ç–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ DOM</button>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ -->
    <div class="test-section">
      <h3>üìç –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤</h3>

      <div class="form-group" id="form_3">
        <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
        <input type="text" id="username" class="form-control">
      </div>

      <div class="test-buttons">
        <button class="btn btn-primary" id="btn_render_4">üìù renderError()</button>
        <button class="btn btn-info" id="btn_check_marker_4">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å data-modia-error</button>
      </div>

      <div class="mt-3">
        <div class="marker-output" id="marker_output">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥ -->
    <div class="test-section">
      <h3>üìã –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥</h3>
      <div class="event-log" id="console-log" style="max-height: 300px;"></div>
      <div class="test-buttons">
        <button class="btn btn-secondary" id="btn_clear_log">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>
    </div>

    <hr>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∞–º -->
    <div class="test-buttons">
      <a href="test-02-styles.html" class="btn btn-outline-primary">–°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç: –°—Ç–∏–ª–∏ ‚Üí</a>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å!) -->
  <script type="module">
    import { FieldErrorRenderer } from '../../../modia/services/field-error-renderer.js';
    import { logger } from '../../../modia/services/logger.js';

    // ========================================
    // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    // ========================================
    function logToPage(message, type = 'info') {
      const $log = $('#console-log');
      const timestamp = new Date().toLocaleTimeString('ru-RU');
      const color = type === 'error' ? 'text-danger'
        : type === 'success' ? 'text-success'
          : 'text-muted';
      $log.append(`<div class="${color}"><small>[${timestamp}] ${message}</small></div>`);
      $log.scrollTop($log[0].scrollHeight);
      console.log(`[FieldErrorRenderer Test] ${message}`);
    }

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç logger.info/warn/error –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const originalInfo = logger.info;
    const originalWarn = logger.warn;
    const originalError = logger.error;

    logger.info = function (message, context) {
      logToPage(`[INFO] [${context || 'Test'}] ${message}`, 'info');
      originalInfo.call(logger, message, context);
    };

    logger.warn = function (message, context) {
      logToPage(`[WARN] [${context || 'Test'}] ${message}`, 'error');
      originalWarn.call(logger, message, context);
    };

    logger.error = function (message, context) {
      logToPage(`[ERROR] [${context || 'Test'}] ${message}`, 'error');
      originalError.call(logger, message, context);
    };

    // ========================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–µ—Ä–æ–≤
    // ========================================
    const renderer1 = new FieldErrorRenderer($('#email'));
    const renderer2 = new FieldErrorRenderer($('#phone'));
    const renderer3 = new FieldErrorRenderer($('#password'));
    const renderer4 = new FieldErrorRenderer($('#username'));

    logToPage('FieldErrorRenderer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');

    // ========================================
    // –£—Ç–∏–ª–∏—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    // ========================================
    function updateStatus(elementId, hasError) {
      const $el = $('#' + elementId);
      $el.removeClass('has-error no-error')
        .addClass(hasError ? 'has-error' : 'no-error')
        .text(`hasError(): ${hasError}`);
    }

    // ========================================
    // –°–µ–∫—Ü–∏—è 1: –ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
    // ========================================
    $('#btn_render_1').on('click', function () {
      renderer1.renderError('<span class="text-danger">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å</span>');
      updateStatus('status_1', renderer1.hasError());
    });

    $('#btn_clear_1').on('click', function () {
      renderer1.clearError();
      updateStatus('status_1', renderer1.hasError());
    });

    $('#btn_check_1').on('click', function () {
      // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –µ—Å—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è
      const hasError = renderer1.hasError();
      updateStatus('status_1', hasError);
      logToPage(`hasError() –ø—Ä–æ–≤–µ—Ä–∫–∞: ${hasError}`, hasError ? 'success' : 'info');
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 2: Fallback –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    // ========================================
    $('#btn_render_2').on('click', function () {
      renderer2.renderError('<span class="text-danger">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω</span>');
      updateStatus('status_2', renderer2.hasError());
    });

    $('#btn_clear_2').on('click', function () {
      renderer2.clearError();
      updateStatus('status_2', renderer2.hasError());
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 3: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    // ========================================
    $('#btn_render_3').on('click', function () {
      renderer3.renderError('<span class="text-danger">–û—à–∏–±–∫–∞ 1</span>');
      renderer3.renderError('<span class="text-danger">–û—à–∏–±–∫–∞ 2</span>');
      renderer3.renderError('<span class="text-danger">–û—à–∏–±–∫–∞ 3</span>');
      logToPage('renderError() –≤—ã–∑–≤–∞–Ω 3 —Ä–∞–∑–∞', 'info');
    });

    $('#btn_count_3').on('click', function () {
      const errorCount = $('[data-modia-error^="form_2:"]').length;
      $('#status_3').removeClass('has-error no-error')
        .addClass(errorCount === 1 ? 'no-error' : 'has-error')
        .text(`–û—à–∏–±–æ–∫ –≤ DOM: ${errorCount}`);
      logToPage(`–ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${errorCount} (–æ–∂–∏–¥–∞–ª–æ—Å—å: 1)`, errorCount === 1 ? 'success' : 'error');
    });

    // ========================================
    // –°–µ–∫—Ü–∏—è 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
    // ========================================
    $('#btn_render_4').on('click', function () {
      renderer4.renderError('<span class="text-danger">–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ</span>');
    });

    $('#btn_check_marker_4').on('click', function () {
      const $error = $('[data-modia-error^="form_3:"]').first();
      if ($error.length) {
        const marker = $error.attr('data-modia-error');
        const fieldData = $error.data('modiaErrorField');
        const containerData = $error.data('modiaErrorContainer');

        const output = {
          'data-modia-error': marker,
          'data("modiaErrorField")': fieldData ? fieldData.tagName : 'null',
          'data("modiaErrorContainer")': containerData ? containerData.tagName : 'null',
          'HTML': $error[0].outerHTML
        };

        $('#marker_output').text(JSON.stringify(output, null, 2));
        logToPage(`–ú–∞—Ä–∫–µ—Ä –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${marker}`, 'success');
      } else {
        $('#marker_output').text('–û—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ renderError() —Å–Ω–∞—á–∞–ª–∞.');
        logToPage('–û—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
      }
    });

    // ========================================
    // –£—Ç–∏–ª–∏—Ç—ã
    // ========================================
    $('#btn_clear_log').on('click', function () {
      $('#console-log').empty();
      logToPage('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
    });

    // –ù–∞—á–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logToPage('–¢–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    logToPage('–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ logger', 'info');
  </script>
</body>

</html>